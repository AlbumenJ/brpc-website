<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.86.0" />
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>MOSN 平滑升级原理解析 | bRPC</title><meta property="og:title" content="MOSN 平滑升级原理解析" />
<meta property="og:description" content="如何在升级 Sidecar（MOSN）的时候而不影响业务，对于存量的长连接如何迁移，本文将为你介绍 MOSN 的解决之道。
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://brpc.incubator.apache.org/docs/concept/smooth-upgrade/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2020-01-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-27T17:53:02+08:00" /><meta property="og:site_name" content="bRPC" />

<meta itemprop="name" content="MOSN 平滑升级原理解析">
<meta itemprop="description" content="如何在升级 Sidecar（MOSN）的时候而不影响业务，对于存量的长连接如何迁移，本文将为你介绍 MOSN 的解决之道。
"><meta itemprop="datePublished" content="2020-01-20T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-07-27T17:53:02+08:00" />
<meta itemprop="wordCount" content="1194">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MOSN 平滑升级原理解析"/>
<meta name="twitter:description" content="如何在升级 Sidecar（MOSN）的时候而不影响业务，对于存量的长连接如何迁移，本文将为你介绍 MOSN 的解决之道。
"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-93485976-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




<link rel="preload" href="/scss/main.min.6c022a2695e1b7248646a4d8e9854baa2e7b3dec122dbfd8d0a958f44f5392f8.css" as="style">
<link href="/scss/main.min.6c022a2695e1b7248646a4d8e9854baa2e7b3dec122dbfd8d0a958f44f5392f8.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>





    <title>MOSN 平滑升级原理解析 | bRPC</title>
  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg width="303" height="259" viewBox="0 0 303 259" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>brpc_logo.svg</title><defs><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-2"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-3"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-4"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="椭圆形" fill="#58b8ff" cx="23.5" cy="62.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="279.5" cy="60.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="119" cy="26" r="26"/><rect id="矩形" fill="#58b8ff" transform="translate(78.021813, 41.967662) rotate(-22.000000) translate(-78.021813, -41.967662)" x="30.0218125" y="35.9676616" width="96" height="12"/><rect id="矩形" fill="#58b8ff" transform="translate(201.451088, 44.299021) rotate(13.000000) translate(-201.451088, -44.299021)" x="138.951088" y="38.2990214" width="125" height="12"/><g id="brpc-logo" transform="translate(11.000000, 104.000000)" fill-rule="nonzero"><g id="编组" transform="translate(138.000000, 77.419111) scale(-1, 1) rotate(-180.000000) translate(-138.000000, -77.419111) translate(0.000000, 0.000000)"><path d="M18.8 154.3C17.8 154.1 17 153.8 17 153.6 17 153.5 13.2 134.3 8.5 111 3.8 87.7-205355861e-22 68-205355861e-22 67.4-205355861e-22 65.9 2.6 65.3 5.7 65.8 7.3 66.1 8.1 67.2 8.6 69.6 9.3 73.5 10 73.8 11.7 71.1 15 65.9 28.8 63.2 36.4 66.4 48.9 71.6 57.7 89.6 56.8 108.1c-.5 10-2.5 14.5-7.8 17.1C44.5 127.5 36.6 127.5 31.4 125.1 27 123.1 20.8814242 116.827994 20 115.8 19.8268414 115.598047 19.5 115 19 115.2 18.3 115.4 18.3 116.5 19 118.7 19.6 120.4 21.6 129 23.4 137.8l3.3 16L24.6 154.4C22.3 155 21.4 155 18.8 154.3zm24.6146505-36.885789c1.7578246-1.326292 2.0864078-1.825452 2.4530432-2.642066S46.8138702 112.705545 47.1008328 111.513935C48.333925 109.104457 47.0101697 95.2413285 45.0724535 89.7736686 41.197021 79.2090375 34.9434822 73 28.2495534 73c-4.5800565.0-7.4866309 1.5754274-11.5382193 6.1163653-1.6734822 1.8534441-1.598743 2.8514069-2.0391331 4.4738936C14.2318109 85.2127457 15.3810952 94.5991493 17.4068894 98.6767262 18.5085881 100.995054 18.5085881 100.995054 20.3179492 104.427606 20.9381193 105.604136 23.3268821 108.69306 24.5063492 109.790864c1.2349847 1.149478 2.6574201 2.834639 3.7432042 3.921533 1.1506404 1.15181600000001 4.2465085 3.084017 5.3028342 3.701814 1.4321645.837608000000003 2.774919 1.362015 4.0282636 1.573221C40.1349135 119.080104 41.2462694 118.670624 43.4146505 117.414211z" id="形状" fill="url(#linearGradient-1)"/><path d="M248.7 148.9C241 147.8 232.2 143 226.1 136.5c-14.2-15-20-43.1-12.1-58.6C216.6 72.9 223.2 67.5 228.5 66 235.2 64.1 249.3 65.1 255.7 67.9 258.6 69.2 261.4 70.8 262.1 71.6 263.7 73.5 265 79.9 263.9 80.6 263.4 80.9 260 79.6 256.3 77.8 243 71.3 230.4 73.3 225.1 82.9 218.5 94.9 223.7 119.3 235.5 131.5 245.8 142 257.4 142.9 271.3 134.2 273.7 132.7 274.2 132.7 275 134 275.5 134.8 276 137.2 276 139.2 276 142.2 275.5 143.2 272.8 144.8 266.2 148.7 257.7 150.2 248.7 148.9z" id="路径" fill="#fff"/><path d="M87.4 148.1C86.2 147.6 84.9 146.7 84.6 146.1 83.6 144.5 68.1 66.6 68.7 65.8c.599999999999994-1 7.5-1 9 0C78.4 66.3 80.6 74.4 82.5 83.9s3.7 17.6 4 18.2C87.5 103.6 96.3 103.1 99.9 101.2 105.7 98.3 107.2 95.2 110 79.7l2.5-14.2L117.3 65.2C123.5 64.8 123.7 65.7 121.6 78.4c-2.5 14.4-4.5 21.2-7.3 24.2C113 104 112 105.3 112.2 105.5 112.4 105.6 114.3 106.7 116.5 107.8 124.5 111.9 129.8 119.6 130.7 128.5 131.7 138 127.9 143.9 119 146.9 114.5 148.4 90.2 149.3 87.4 148.1zm24.9-9.5C117.8 136.3 119.3 133.8 118.8 127.7 117.9 117 111.3 112.1 96.6 111.2L87.7 110.7 88.3 113.1C88.6 114.4 89.8 120.5 91 126.5 92.1 132.6 93.3 138.1 93.5 138.8 94.1 140.5 108.1 140.4 112.3 138.6z" id="形状" fill="#fff"/><path d="M159.5 148.4C158.4 148.1 157.2 147.5 156.7 147.1c-1-1-16.8-80.2-16.1-81.2C141.2 64.8 148 64.7 149.7 65.8 150.3 66.2 152.2 73.3 153.8 81.5L156.7 96.5 167.8 97.1c17.1 1 25.5 5.7 31.2 17.2C206.2 129.1 202.4 143.6 190.5 146.9 186.1 148.1 162.6 149.2 159.5 148.4zm27.2-11C195 131.2 191.3 114.2 180.5 108.6 177.6 107.1 174.2 106.4 167.8 106.2 162.9 106 159 106.2 159 106.7 159 107.1 160.4 114.9 162.1 123.9L165.3 140.2 174.6 139.8C182.1 139.5 184.5 139 186.7 137.4z" id="形状" fill="#fff"/><path d="M52.3 50.7C49 41.2 49.5 37.5 52.9 46.5c1.2 3.1 1.9876864 5.9098389 2.1 6.3S55.4 54.1 55.9 54.9C56.6 56 58.2 55.2 63.5 50.9 67.2 47.9 70.4 45.6 70.6 45.8 71.7 46.5 70.9 47.4 64.1 53.2 60 56.6 58.2983882 57.6981689 57.4 58.2 56.5016118 58.7018311 56.5016118 58.7018311 55.8 58.2 55 57.49737 54 55.4 52.3 50.7z" id="形状" fill="#7e7e7e"/><path d="M84 34.1C84 30.6 82.8 29 80.4 29 78.9 29 78 28.4 78 27.5 78 26.7 78.9 26 80 26 82.4 26 82.4 25.5 80.5 17 79.7 13.4 79.1 8.4 79 5.8 79 1.6 79.3 1 81.4.4 85.1-.5 89.5.3 89.8 2 90 3.1 89.2 3.5 86.8 3.5 83.9 3.5 83.5 3.8 83.3 6.5 83.1 8.2 83.8 13.1 84.8 17.5c1.7 7.9 1.7 8 5.2 8.6L93.5 26.7C94.2848943 26.7875501 94.751561 26.9875501 94.9 27.3 95 28.6 94.2 29 91.1 29h-4L87.7 32.5C88.2 35.6 88 36 86.1 36 84.7 36 84 35.4 84 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M105 34.1C105 30.6 103.8 29 101.4 29 99.9 29 99 28.4 99 27.5 99 26.7 99.9 26 101 26 103.4 26 103.4 25.5 101.5 17 100.7 13.4 100.1 8.4 1e2 5.8 1e2 1.6 100.3 1 102.4.4 106.1-.5 110.5.3 110.8 2 111 3.1 110.2 3.5 107.8 3.5 104.9 3.5 104.5 3.8 104.3 6.5 104.1 8.2 104.8 13.1 105.8 17.5c1.7 7.9 1.7 8 5.2 8.6L114.5 26.7C115.433333 26.8462934 115.9 27.0462934 115.9 27.3 116 28.6 115.2 29 112.1 29h-4L108.7 32.5C109.2 35.6 109 36 107.1 36 105.7 36 105 35.4 105 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M54.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C46.5 1.9 48.6.0 57.2.0 63.6.0 67 1.2 67 3.6 67 4.7 66.6 4.8 65.1 4c-2.7-1.4-10.4-1.3-12.4.3C51.8 4.9 51 6.6 50.9 8 50.4 13.5 50.6 13.7 57.8 14.2 66 14.9 69.5 16.4 71 20 72.3 23.2 71.2 26.3 68 28s-10.2 1.1-13.7-1.1zM67 22.7C67 19 63.6 17 57.3 17 54.4 17 52 17.3 52 17.8c0 1.1 3.1 5.4 5 7C57.9 25.5 60.2 25.9 62.8 25.7 65.1 25.4 67 26.1 67 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M126.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C118.5 1.9 120.6.0 129.2.0 135.6.0 139 1.2 139 3.6 139 4.7 138.6 4.8 137.1 4 134.4 2.6 126.7 2.7 124.7 4.3 123.8 4.9 123 6.6 122.9 8 122.4 13.5 122.6 13.7 129.8 14.2 138 14.9 141.5 16.4 143 20 144.3 23.2 143.2 26.3 140 28s-10.2 1.1-13.7-1.1zM139 22.7C139 19 135.6 17 129.3 17 126.4 17 124 17.3 124 17.8 124 18.9 127.1 23.2 129 24.8 129.9 25.5 132.2 25.9 134.8 25.7 137.1 25.4 139 26.1 139 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M153.7 26.8C151.7 18.4 149.2978 2.90464869 149.2978 2.1 149.2978 1.77371339 148.894918.241544332 150.3.1 151.705082-.0415443324 153 .4 153 2.1 153 3.2 153.7 7.2 154.6 11 156.5 19.3 161 25.2 165.5 25.4 167.5 25.5 168.6 26.1 168.8 27.3 169.1 28.6 168.4 29 165.8 29 163.2 29 161.6 28.2 159.4 25.8L156.5 22.5C155.5 19.6333333 155.133333 18.4333333 155.4 18.9 155.9 19.7 156.5 22.2 156.7 24.6 156.9 27.9 156.7 29 155.6 29 154.8 29 154 28 153.7 26.8z" id="形状" fill="url(#linearGradient-4)"/></g></g></g></svg></span>
        
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://github.com/apache/incubator-brpc/" target="_blank" ><span>GitHub</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/blog/" ><span>博客</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/docs/community/" ><span>社区</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/docs/faq/" ><span>FAQ</span></a>
			</li>
			
			
			
			<li class="nav-item dropdown d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/en/docs/concept/smooth-upgrade/">English</a>
	
</div>
			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label="搜索本站" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    
<input type="search" class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label="搜索本站" autocomplete="off">

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav pt-2 pl-4" id="td-section-nav">
    
    <div class="nav-item dropdown d-block d-lg-none">
      

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/en/docs/concept/smooth-upgrade/">English</a>
	
</div>
    </div>
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a>
  </li>
  <ul>
    <li class="collapse show" id="docs">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsoverview" href="/docs/overview/">简介</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/quick-start/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">开始</a>
  </li>
  <ul>
    <li class="collapse " id="docsquick-start">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsquick-startproxy" href="/docs/quick-start/proxy/">快速开始</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsquick-startistio" href="/docs/quick-start/istio/">集成 Istio</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/concept/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">架构原理</a>
  </li>
  <ul>
    <li class="collapse show" id="docsconcept">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptcore-concept" href="/docs/concept/core-concept/">核心概念</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptsidecar-pattern" href="/docs/concept/sidecar-pattern/">Sidecar 模式</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconcepttraffic-hijack" href="/docs/concept/traffic-hijack/">流量劫持</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconcepttls" href="/docs/concept/tls/">TLS 安全链路</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page  active" id="m-docsconceptsmooth-upgrade" href="/docs/concept/smooth-upgrade/">MOSN 平滑升级原理解析</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptmulti-protocol" href="/docs/concept/multi-protocol/">MOSN 多协议机制解析</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptextensions" href="/docs/concept/extensions/">MOSN 扩展机制解析</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docssamples" href="/docs/samples/">工程示例</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">配置概览</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfiguration">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationclustermanager" href="/docs/configuration/clustermanager/">ClusterManager 配置</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/server/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Server 配置</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfigurationserver">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationserverrouter" href="/docs/configuration/server/router/">Router 配置</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/server/listener/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Listener 配置</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfigurationserverlistener">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationserverlistenerfilter-chain" href="/docs/configuration/server/listener/filter-chain/">FilterChain</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/server/listener/network-filter/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Network Filter</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfigurationserverlistenernetwork-filter">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationserverlistenernetwork-filterproxy" href="/docs/configuration/server/listener/network-filter/proxy/">proxy</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationserverlistenernetwork-filterconnection-manager" href="/docs/configuration/server/listener/network-filter/connection-manager/">connection_manager</a>
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/trace/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Trace 配置</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfigurationtrace">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationtraceskywalking" href="/docs/configuration/trace/skywalking/">SkyWalking 配置</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationcustom" href="/docs/configuration/custom/">自定义配置</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/dev/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">开发指南</a>
  </li>
  <ul>
    <li class="collapse " id="docsdev">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsdevrelease" href="/docs/dev/release/">版本发布 介绍</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsdevdubbo-integrate" href="/docs/dev/dubbo-integrate/">Dubbo 集成</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsdevfeaturegate-introduce" href="/docs/dev/featuregate-introduce/">Featuregate 介绍</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/contribute/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">贡献文档</a>
  </li>
  <ul>
    <li class="collapse " id="docscontribute">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscontributegithub" href="/docs/contribute/github/">文档贡献指南</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscontributecreating-pages" href="/docs/contribute/creating-pages/">创建页面</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscontributestyle-guide" href="/docs/contribute/style-guide/">样式指南</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsfaq" href="/docs/faq/">FAQ</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscommunity" href="/docs/community/">社区</a>
      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">





<a href="https://github.com/apache/incubator-brpc-website/edit/master/content/zh/docs/concept/smooth-upgrade/index.md" target="_blank"><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
<a href="https://github.com/apache/incubator-brpc-website/issues/new?title=MOSN%20%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7%e5%8e%9f%e7%90%86%e8%a7%a3%e6%9e%90" target="_blank"><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>


<a href="https://github.com/apache/incubator-brpc/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a>

</div>






<nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#正常流程">正常流程</a></li>
    <li><a href="#平滑升级流程">平滑升级流程</a>
      <ul>
        <li><a href="#触发条件">触发条件</a></li>
        <li><a href="#交互流程">交互流程</a></li>
        <li><a href="#长连接迁移流程">长连接迁移流程</a></li>
        <li><a href="#残留响应迁移流程">残留响应迁移流程</a></li>
        <li><a href="#连接状态数据">连接状态数据</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#反馈">反馈</a></li>
  </ul>
</nav>



          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		










<li class="breadcrumb-item" >
	<a href="/docs/">文档</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/concept/">架构原理</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/docs/concept/smooth-upgrade/">MOSN 平滑升级原理解析</a>
</li>

	</ol>
</nav	>


            
<div class="td-content">
	<h1>MOSN 平滑升级原理解析</h1>
	<div class="lead">如何在升级 Sidecar（MOSN）的时候而不影响业务，对于存量的长连接如何迁移，本文将为你介绍 MOSN 的解决之道。</div>
	<p>Service Mesh 中 Sidecar 运维一直是一个比较棘手的问题，数据平面的 Sidecar 升级是常有的事情，如何在升级 Sidecar（MOSN）的时候而不影响业务，对于存量的长连接如何迁移，本文将为你介绍 MOSN 的解决之道。</p>
<h2 id="背景">背景</h2>
<p>本文介绍 MOSN 支持平滑升级的原因和解决方案，对于平滑升级的一些基础概念，大家可以通过 <a href="https://ms2008.github.io/2019/12/28/hot-upgrade/">Nginx vs Enovy vs Mosn 平滑升级原理解析</a>了解。</p>
<p>先简单介绍一下为什么 Nginx 和 Envoy 不需要具备 MOSN 这样的连接无损迁移方案，主要还是跟业务场景相关，Nginx 和 Envoy 主要支持的是 HTTP1 和 HTTP2 协议，HTTP1使用 connection: Close，HTTP2 使用 Goaway Frame 都可以让 Client 端主动断链接，然后新建链接到新的 New process，但是针对 Dubbo、SOFA PRC 等常见的多路复用协议，它们是没有控制帧，Old process 的链接如果断了就会影响请求的。</p>
<p>一般的升级做法就是切走应用的流量，比如自己UnPub掉服务，等待一段时间没有请求之后，升级MOSN，升级好之后再Pub服务，整个过程比较耗时，并且会有一段时间是不提供服务的，还要考虑应用的水位，在大规模场景下，就很难兼顾评估。MOSN 为了满足自身业务场景，开发了长连接迁移方案，把这条链接迁移到 New process 上，整个过程对 Client 透明，不需要重新建链接，达到请求无损的平滑升级。</p>
<p><img src="reqeust-smooth-upgrade-process.png" alt="MOSN 的请求无损的平滑升级过程"></p>
<h2 id="正常流程">正常流程</h2>
<p><img src="normal-process.png" alt="正常流程"></p>
<ol>
<li>Client 发送请求 Request 到 MOSN</li>
<li>MOSN 转发请求 Request 到 Server</li>
<li>Server 回复响应 Response 到 MOSN</li>
<li>MOSN 回复响应 Response 到 Client</li>
</ol>
<p>上图简单介绍了一个请求的正常流程，我们后面需要迁移的是 TCP1 链接，也就是 Client 到 MOSN 的连接，MOSN 到 Server 的链接 TCP2 不需要迁移，因为 MOSN 访问 Server 是根据 LoadBalance 选择，我们可以主动控制断链建链。</p>
<h2 id="平滑升级流程">平滑升级流程</h2>
<h3 id="触发条件">触发条件</h3>
<p>有两个方式可以触发平滑升级流程：</p>
<ol>
<li>MOSN 对 SIGHUP 做了监听，发送 SIGHUP 信号给 MOSN 进程，通过 ForkExec 生成一个新的 MOSN 进程。</li>
<li>直接重新启动一个新 MOSN 进程。</li>
</ol>
<p>为什么提供两种方式？最开始我们支持的是方法1，也就是 nginx 和 Envoy 使用的方式，这个在虚拟机或者容器内替换 MOSN 二级制来升级是可行的，但是我们的场景需要满足容器间的升级，所以需要新拉起一个容器，就需要重新启动一个新的 MOSN 进程来做平滑升级，所以后续又支持了方法2。容器间升级还需要 operator 的支持，本文不展开叙述。</p>
<h3 id="交互流程">交互流程</h3>
<p><img src="interaction-process.png" alt="交互流程"></p>
<p><img src="interaction-process-timeline.png" alt="交互流程时序图"></p>
<p>首先，老的 MOSN 在启动最后阶段会启动一个协程运行 <code>ReconfigureHandler()</code> 函数监听一个 Domain Socket（<code>reconfig.sock</code>）, 该接口的作用是让新的 MOSN 来感知是否存在老的 MOSN。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ReconfigureHandler</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">l</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unix&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReconfigureDomainSocket</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">uc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ul</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AcceptUnix</span><span style="color:#000;font-weight:bold">()</span>
        <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">uc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">})</span>
        <span style="color:#000">reconfigure</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>触发平滑升级流程的两种方式最终都是启动一个新的 MOSN 进程，然后调用<code>GetInheritListeners()</code>，通过 <code>isReconfigure()</code> 函数来判断本机是否存在一个老的 MOSN（就是判断是否存在 <code>reconfig.sock</code> 监听），如果存在一个老的 MOSN，就进入迁移流程，反之就是正常的启动流程。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8f5902;font-style:italic">// 保留了核心流程
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">GetInheritListeners</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listener</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">isReconfigure</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000">l</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unix&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TransferListenDomainSocket</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">uc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ul</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AcceptUnix</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oobn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">uc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadMsgUnix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oob</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">fileListener</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileListener</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">listeners</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">uc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>如果进入迁移流程，新的 MOSN 将监听一个新的 Domain Socket（<code>listen.sock</code>），用于老的 MOSN 传递 listen FD 到新的 MOSN。FD 的传递使用了sendMsg 和 recvMsg。在收到 listen FD 之后，调用 <code>net.FileListener()</code> 函数生产一个 Listener。此时，新老 MOSN 都同时拥有了相同的 Listen 套接字。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8f5902;font-style:italic">// FileListener returns a copy of the network listener corresponding
</span><span style="color:#8f5902;font-style:italic">// to the open file f.
</span><span style="color:#8f5902;font-style:italic">// It is the caller&#39;s responsibility to close ln when finished.
</span><span style="color:#8f5902;font-style:italic">// Closing ln does not affect f, and closing f does not affect ln.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FileListener</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ln</span> <span style="color:#000">Listener</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">ln</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fileListener</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">OpError</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Op</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Net</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;file+net&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Source</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Addr</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fileAddr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">Err</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>这里的迁移和 Nginx 还是有一些区别，Nginx 是 fork 的方式，子进程自动就继承了 listen FD，MOSN 是新启动的进程，不存在父子关系，所以需要通过 sendMsg 的方式来传递。</p>
<p>在进入迁移流程和 Listen 的迁移过程中，一共使用了两个 Domain Socket：</p>
<ul>
<li><code>reconfig.sock</code> 是 Old MOSN 监听，用于 New MOSN 来判断是否存在</li>
<li><code>listen.sock</code> 是 New MOSN 监听，用于 Old MOSN 传递 listen FD</li>
</ul>
<p>两个 sock 其实是可以复用的，也可以用 <code>reconfig.sock</code> 进行 listen 的传递，由于一些历史原因搞了两个，后续可以优化为一个，让代码更精简易读。</p>
<p>这儿再看看 Old MOSN 的处理，在收到 New MOSN 的通知之后，将进入<code>reconfigure(false)</code> 流程，首先就是调用 <code>sendInheritListeners()</code> 传递 listen FD，原因上面内容已经描述，最后调用 <code>WaitConnectionsDone()</code> 进入存量长链接的迁移流程。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8f5902;font-style:italic">// 保留了核心流程
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">reconfigure</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">start</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">startNewMosn</span><span style="color:#000;font-weight:bold">()</span>
        <span style="color:#204a87;font-weight:bold">return</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#8f5902;font-style:italic">// transfer listen fd
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">notify</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sendInheritListeners</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#8f5902;font-style:italic">// Wait for all connections to be finished
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">WaitConnectionsDone</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">GracefulTimeout</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>在 Listen FD 迁移之后，New MOSN 通过配置启动，然后在最后启动一个协程运行<code>TransferServer()</code>，将监听一个新的 <code>DomainSocket（conn.sock）</code>，用于后续接收 Old MOSN 的长连接迁移。迁移的函数是 <code>transferHandler()</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TransferServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">handler</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConnectionHandler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">l</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unix&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TransferConnDomainSocket</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#000">utils</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GoWithRecover</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Accept</span><span style="color:#000;font-weight:bold">()</span>
            <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">transferHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">transferMap</span><span style="color:#000;font-weight:bold">)</span>

        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Old MOSN 将通过 <code>transferRead()</code> 和 <code>transferWrite()</code> 进入最后的长链接迁移流程，下面主要分析这块内容。</p>
<h3 id="长连接迁移流程">长连接迁移流程</h3>
<p><img src="long-connection-migrating-process.png" alt="长连接迁移过程"></p>
<p>首先先粗略看一下新请求的迁移流程。</p>
<ol>
<li>Client 发送请求到 MOSN</li>
<li>MOSN 通过 domain  socket(conn.sock) 把 TCP1 的 FD 和连接的状态数据发送给 New MOSN</li>
<li>New  MOSN 接受 FD 和请求数据创建新的 Conection 结构，然后把 Connection id 传给 MOSN，New MOSN 此时就拥有了 TCP1 的一个拷贝。</li>
<li>New  MOSN 通过 LB 选取一个新的 Server，建立 TCP3 连接，转发请求到 Server</li>
<li>Server 回复响应到 New MOSN</li>
<li>New MOSN 通过 MOSN 传递来的 TCP1 的拷贝，回复响应到 Client</li>
</ol>
<p>之前的 <code>WaitConnectionsDone()</code> 函数中，<code>s.stopChan</code> 已经关闭，在链接的 ReadLoop 中，将设置一个 <code>[TransferTimeout, 2 * TransferTimeout]</code> 的随机时间进入迁移流程，随机数主要是为了打散每个 Client 的 TCP 连接迁移时机，让迁移更平滑。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">startReadLoop</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">transferTime</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span>
    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">:</span>
            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">transferTime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsZero</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">transferCallbacks</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">transferCallbacks</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#000">randTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Intn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TransferTimeout</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Nanoseconds</span><span style="color:#000;font-weight:bold">())))</span>
                    <span style="color:#000">transferTime</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TransferTimeout</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">randTime</span><span style="color:#000;font-weight:bold">)</span>
                    <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultLogger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[network] [read loop] transferTime: Wait %d Second&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">TransferTimeout</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">randTime</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">1e9</span><span style="color:#000;font-weight:bold">)</span>
                <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#8f5902;font-style:italic">// set a long time, not transfer connection, wait mosn exit.
</span><span style="color:#8f5902;font-style:italic"></span>                    <span style="color:#000">transferTime</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">TransferTimeout</span><span style="color:#000;font-weight:bold">)</span>
                    <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultLogger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[network] [read loop] not support transfer connection, Connection = %d, Local Address = %+v, Remote Address = %+v&#34;</span><span style="color:#000;font-weight:bold">,</span>
                        <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rawConnection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LocalAddr</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteAddr</span><span style="color:#000;font-weight:bold">())</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">transferTime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Before</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">transfer</span><span style="color:#000;font-weight:bold">()</span>
                    <span style="color:#204a87;font-weight:bold">return</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>在等待一个随机时间之后，<code>c.tranfer()</code> 将进入迁移流程，<code>c.notifyTransfer()</code> 的作用是暂停 write 操作，在迁移 read 操作的时候，不能有 write 操作，因为两个进程 MOSN 同时都做 write，会导致数据错乱。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">transfer</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">notifyTransfer</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">transferRead</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">transferWrite</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>然后进入的是 <code>transferRead()</code>，这个函数的作用就是把连接的 FD 和状态数据通过 <code>conn.sock</code>传递给 New MOSN，跟之前迁移 Listen FD 时方式一样，NEW MOSN 在成功处理之后会返回一个 ID，这个 ID 是 NEW MOSN 新建立的 Connection ID，这个 ID 后面会用到。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8f5902;font-style:italic">// old mosn transfer readloop
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">transferRead</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">uint64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">unixConn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dial</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unix&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TransferConnDomainSocket</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#000">file</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tlsConn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">transferGetFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#000">uc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">unixConn</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UnixConn</span><span style="color:#000;font-weight:bold">)</span>
    
    <span style="color:#8f5902;font-style:italic">// send type and TCP FD
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">transferSendType</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">file</span><span style="color:#000;font-weight:bold">)</span>
    
    <span style="color:#8f5902;font-style:italic">// send header + buffer + TLS
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">transferReadSendData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tlsConn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">readBuffer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultLogger</span><span style="color:#000;font-weight:bold">)</span>
    
    <span style="color:#8f5902;font-style:italic">// recv ID
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">transferRecvID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uc</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>我们构造了一个简单的读迁移协议, 主要包括了 TCP 原始数据长度，TLS 数据长度，TCP 原始数据，TLS 数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ce5c00;font-weight:bold">/**</span>
 <span style="color:#ce5c00;font-weight:bold">*</span>  <span style="color:#000">transfer</span> <span style="color:#000">read</span> <span style="color:#000">protocol</span>
 <span style="color:#ce5c00;font-weight:bold">*</span>  <span style="color:#000">header</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">readBuffer</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">TLS</span>
 <span style="color:#ce5c00;font-weight:bold">*</span>
 <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">0</span>                       <span style="color:#0000cf;font-weight:bold">4</span>                       <span style="color:#0000cf;font-weight:bold">8</span>
 <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#ce5c00;font-weight:bold">+-----+-----+-----+-----+-----+-----+-----+-----+</span>
 <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#000">data</span> <span style="color:#000">length</span>      <span style="color:#000;font-weight:bold">|</span>     <span style="color:#000">TLS</span> <span style="color:#000">length</span>        <span style="color:#000;font-weight:bold">|</span>
 <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#ce5c00;font-weight:bold">+-----+-----+-----+-----+-----+-----+-----+-----+</span>
 <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">|</span>                     <span style="color:#000">data</span>                      <span style="color:#000;font-weight:bold">|</span>
 <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#ce5c00;font-weight:bold">+-----+-----+-----+-----+-----+-----+-----+-----+</span>
 <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">|</span>                     <span style="color:#000">TLS</span>                       <span style="color:#000;font-weight:bold">|</span>
 <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#ce5c00;font-weight:bold">+-----+-----+-----+-----+-----+-----+-----+-----+</span>
 <span style="color:#ce5c00;font-weight:bold">*</span>
</code></pre></div><p>现在看下 New MOSN 收到迁移请求之后的处理，它会针对每个迁移请求会启动一个协程运行 <code>transferHandler()</code> 函数, 函数会根据读取的协议判断是读迁移还是写迁移，我们这儿先介绍读迁移，New MOSN 会调用 transferNewConn 把 Old MOSN 传递过来的 FD 和数据包重新生成一个新的 Connection 结构体，并把生成的新的 connection ID 传递给 Old MOSN。</p>
<p>此后，New MOSN 将从该 TCP 连接读取数据，开始正常的业务请求流程。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">transferHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConnectionHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">transferMap</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Map</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// recv type
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">transferRecvType</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uc</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultLogger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[network] [transfer] [handler] transferRecvType error :%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">return</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">conn</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// transfer read
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// recv header + buffer
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">dataBuf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tlsBuf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">transferReadRecvData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uc</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultLogger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[network] [transfer] [handler] transferRecvData error :%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
            <span style="color:#204a87;font-weight:bold">return</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000">connection</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">transferNewConn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dataBuf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tlsBuf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">transferMap</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">connection</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000">transferSendID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000">transferSendID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">transferErr</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// transfer write
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// recv header + buffer
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">transferWriteRecvData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uc</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultLogger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[network] [transfer] [handler] transferRecvData error :%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000">connection</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">transferFindConnection</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">transferMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">uint64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">connection</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultLogger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[network] [transfer] [handler] transferFindConnection failed, id = %d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span>
            <span style="color:#204a87;font-weight:bold">return</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">transferWriteBuffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultLogger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[network] [transfer] [handler] transferWriteBuffer error :%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
            <span style="color:#204a87;font-weight:bold">return</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>此后，Old MOSN 不再读取该 TCP1 连接上的数据，全部由 New MOSN 来读取 TCP1 上的数据并处理，对于新的请求，整个迁移过程就已经完成。</p>
<h3 id="残留响应迁移流程">残留响应迁移流程</h3>
<p><img src="remaining-responses-migrating-process.png" alt="残留响应迁移过程"></p>
<p>大家想想为什么还有残留响应的迁移流程？因为多路复用协议，在之前读连接迁移流程的时候，TCP2 上还有之前残留的响应需要回复给Client，如果同时 MOSN 和 New MOSN 都进行 Write 操作 TCP1，数据可能会乱序，所以需要让New MOSN来统一处理之前 TCP2 上残留的响应。</p>
<ol>
<li>Server 回复残留的响应到 MOSN</li>
<li>MOSN 把之前从 New MOSN 获取的 Connection id 和响应数据，通过 domain socket(conn.sock) 传递给 New MOSN</li>
<li>New MOSN 通过 id 查询 TCP1 连接，回复响应到 Client</li>
</ol>
<p>在 <code>transferRead()</code> 之后，就进入了 <code>transferWrite()</code> 阶段，该阶段会把需要 write 的数据包和之前 New MOSN 传回来的 Connection ID 一并传给 New MOSN。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8f5902;font-style:italic">// old mosn transfer writeloop
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">transferWrite</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span> <span style="color:#204a87;font-weight:bold">uint64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>

    <span style="color:#000">unixConn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dial</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unix&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TransferConnDomainSocket</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#000">uc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">unixConn</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UnixConn</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">transferSendType</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>

    <span style="color:#8f5902;font-style:italic">// build net.Buffers to IoBuffer
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">buf</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">transferBuildIoBuffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#8f5902;font-style:italic">// send header + buffer
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">transferWriteSendData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultLogger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[network] [transfer] [write] transferWrite failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>我们构造了一个简单的写迁移协议, 主要包括了TCP原始数据长度, connection ID，TCP原始数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> *  transfer write protocol
</span><span style="color:#8f5902;font-style:italic"> *  header (8 bytes) + (writeBuffer data)
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> * 0                       4                       8
</span><span style="color:#8f5902;font-style:italic"> * +-----+-----+-----+-----+-----+-----+-----+-----+
</span><span style="color:#8f5902;font-style:italic"> * |      data length      |    connection  ID     |
</span><span style="color:#8f5902;font-style:italic"> * +-----+-----+-----+-----+-----+-----+-----+-----+
</span><span style="color:#8f5902;font-style:italic"> * |                     data                      |
</span><span style="color:#8f5902;font-style:italic"> * +-----+-----+-----+-----+-----+-----+-----+-----+
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic">**/</span>
</code></pre></div><p>在New MOSN的transferHandler()函数中，会判断出写迁移协议，然后 <code>transferFindConnection()</code> 函数通过 connection ID 找到 TCP1 连接，然后直接把数据写入即可。</p>
<p>这儿需要说明一点，新请求Request的转发已经使用了 TCP3，TCP2 上只会有之前请求的 Response 响应，如果在整个迁移期间 2 * TransferTimeout 都没有回复响应，那么这个请求将会超时失败。</p>
<h3 id="连接状态数据">连接状态数据</h3>
<p>在连接迁移时，除了TCP FD的迁移，还有连接状态的迁移，这样New MOSN才知道怎样去初始化这个新的连接。</p>
<p>主要有如下几个状态：</p>
<p><strong>读缓存</strong></p>
<p>表示在迁移时，已经从 TCP 读取的数据，还没有被应用层处理的数据。</p>
<p><strong>写数据</strong></p>
<p>在迁移之后，MOSN 收到的响应数据。</p>
<p><strong>TLS状态迁移</strong></p>
<p>如果是 TLS 加密请求，需要迁移 TLS 的状态，有如下状态需要迁移：</p>
<ol>
<li>加密秘钥</li>
<li>Seq序列</li>
<li>读缓存数据（加密和未加密）</li>
<li>cipher类型</li>
<li>TLS版本</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">TransferTLSInfo</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">Vers</span>         <span style="color:#204a87;font-weight:bold">uint16</span>
    <span style="color:#000">CipherSuite</span>  <span style="color:#204a87;font-weight:bold">uint16</span>
    <span style="color:#000">MasterSecret</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span>
    <span style="color:#000">ClientRandom</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span>
    <span style="color:#000">ServerRandom</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span>
    <span style="color:#000">InSeq</span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">byte</span>
    <span style="color:#000">OutSeq</span>       <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">byte</span>
    <span style="color:#000">RawInput</span>     <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span>
    <span style="color:#000">Input</span>        <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="总结">总结</h2>
<p>长连接的 FD 迁移是比较常规的操作，sendMsg 和 connection repair 都可以。</p>
<p>在整个过程中最麻烦的是应用层数据的迁移，一般想法就是把应用层的数据结构等都迁移到新的进程，比如已经读取的协议 HEAD 等结构体，但这就导致你的迁移过程会很复杂，每个协议都需要单独处理。</p>
<p>MOSN 的方案是把迁移放到了 IO 层，不关心应用层具体是什么协议，我们迁移最原始的 TCP 数据包，然后让 New MOSN 来 codec 这个数据包来拼装 HEAD 等结构体，这个过程是标准的处理流程了，这样就保证迁移对整个协议解析是透明的，只要这个协议是无状态的，这个迁移框架就可以自动支持。</p>
<p>最后的残留响应迁移流程可能不太好理解，为什么不等所有响应完成之后才开始迁移，就不需要这个流程了？是因为在多路复用协议场景下，请求一直在发送，你不能总是找到一个时间点所有响应都完成了。</p>
<h2 id="反馈">反馈</h2>
<p>关于该问题的讨论请见 Github Issue：<a href="https://github.com/mosn/mosn/issues/866">MOSN smooth upgrade problem #866</a>。</p>

	
	
	<div class="text-muted mt-5 pt-3 border-top">修改于 2020年7月27日: <a  href="https://github.com/apache/incubator-brpc-website/commit/9df005ed5e16d206723cf58b72c4599f8403451c">redirect zh url (9df005e)</a>
</div>
</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-12 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" href="https://github.com/apache/incubator-brpc">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The bRPC Authors 保留所有权利</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>






<script src="/js/main.min.170adf90fd476d5f9243ed2e727149abe8d9fe364587fe943765d47375bbd1ad.js" integrity="sha256-FwrfkP1HbV&#43;SQ&#43;0ucnFJq&#43;jZ/jZFh/6UN2XUc3W70a0=" crossorigin="anonymous"></script>





  </body>
</html>