<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.86.0" />
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Featuregate 介绍 | bRPC</title><meta property="og:title" content="Featuregate 介绍" />
<meta property="og:description" content="本页介绍了 MOSN 的 featuregate。
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://brpc.incubator.apache.org/docs/dev/featuregate-introduce/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2020-03-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-27T17:53:02+08:00" /><meta property="og:site_name" content="bRPC" />

<meta itemprop="name" content="Featuregate 介绍">
<meta itemprop="description" content="本页介绍了 MOSN 的 featuregate。
"><meta itemprop="datePublished" content="2020-03-13T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-07-27T17:53:02+08:00" />
<meta itemprop="wordCount" content="764">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Featuregate 介绍"/>
<meta name="twitter:description" content="本页介绍了 MOSN 的 featuregate。
"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-93485976-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




<link rel="preload" href="/scss/main.min.6c022a2695e1b7248646a4d8e9854baa2e7b3dec122dbfd8d0a958f44f5392f8.css" as="style">
<link href="/scss/main.min.6c022a2695e1b7248646a4d8e9854baa2e7b3dec122dbfd8d0a958f44f5392f8.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>





    <title>Featuregate 介绍 | bRPC</title>
  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg width="303" height="259" viewBox="0 0 303 259" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>brpc_logo.svg</title><defs><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-2"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-3"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-4"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="椭圆形" fill="#58b8ff" cx="23.5" cy="62.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="279.5" cy="60.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="119" cy="26" r="26"/><rect id="矩形" fill="#58b8ff" transform="translate(78.021813, 41.967662) rotate(-22.000000) translate(-78.021813, -41.967662)" x="30.0218125" y="35.9676616" width="96" height="12"/><rect id="矩形" fill="#58b8ff" transform="translate(201.451088, 44.299021) rotate(13.000000) translate(-201.451088, -44.299021)" x="138.951088" y="38.2990214" width="125" height="12"/><g id="brpc-logo" transform="translate(11.000000, 104.000000)" fill-rule="nonzero"><g id="编组" transform="translate(138.000000, 77.419111) scale(-1, 1) rotate(-180.000000) translate(-138.000000, -77.419111) translate(0.000000, 0.000000)"><path d="M18.8 154.3C17.8 154.1 17 153.8 17 153.6 17 153.5 13.2 134.3 8.5 111 3.8 87.7-205355861e-22 68-205355861e-22 67.4-205355861e-22 65.9 2.6 65.3 5.7 65.8 7.3 66.1 8.1 67.2 8.6 69.6 9.3 73.5 10 73.8 11.7 71.1 15 65.9 28.8 63.2 36.4 66.4 48.9 71.6 57.7 89.6 56.8 108.1c-.5 10-2.5 14.5-7.8 17.1C44.5 127.5 36.6 127.5 31.4 125.1 27 123.1 20.8814242 116.827994 20 115.8 19.8268414 115.598047 19.5 115 19 115.2 18.3 115.4 18.3 116.5 19 118.7 19.6 120.4 21.6 129 23.4 137.8l3.3 16L24.6 154.4C22.3 155 21.4 155 18.8 154.3zm24.6146505-36.885789c1.7578246-1.326292 2.0864078-1.825452 2.4530432-2.642066S46.8138702 112.705545 47.1008328 111.513935C48.333925 109.104457 47.0101697 95.2413285 45.0724535 89.7736686 41.197021 79.2090375 34.9434822 73 28.2495534 73c-4.5800565.0-7.4866309 1.5754274-11.5382193 6.1163653-1.6734822 1.8534441-1.598743 2.8514069-2.0391331 4.4738936C14.2318109 85.2127457 15.3810952 94.5991493 17.4068894 98.6767262 18.5085881 100.995054 18.5085881 100.995054 20.3179492 104.427606 20.9381193 105.604136 23.3268821 108.69306 24.5063492 109.790864c1.2349847 1.149478 2.6574201 2.834639 3.7432042 3.921533 1.1506404 1.15181600000001 4.2465085 3.084017 5.3028342 3.701814 1.4321645.837608000000003 2.774919 1.362015 4.0282636 1.573221C40.1349135 119.080104 41.2462694 118.670624 43.4146505 117.414211z" id="形状" fill="url(#linearGradient-1)"/><path d="M248.7 148.9C241 147.8 232.2 143 226.1 136.5c-14.2-15-20-43.1-12.1-58.6C216.6 72.9 223.2 67.5 228.5 66 235.2 64.1 249.3 65.1 255.7 67.9 258.6 69.2 261.4 70.8 262.1 71.6 263.7 73.5 265 79.9 263.9 80.6 263.4 80.9 260 79.6 256.3 77.8 243 71.3 230.4 73.3 225.1 82.9 218.5 94.9 223.7 119.3 235.5 131.5 245.8 142 257.4 142.9 271.3 134.2 273.7 132.7 274.2 132.7 275 134 275.5 134.8 276 137.2 276 139.2 276 142.2 275.5 143.2 272.8 144.8 266.2 148.7 257.7 150.2 248.7 148.9z" id="路径" fill="#fff"/><path d="M87.4 148.1C86.2 147.6 84.9 146.7 84.6 146.1 83.6 144.5 68.1 66.6 68.7 65.8c.599999999999994-1 7.5-1 9 0C78.4 66.3 80.6 74.4 82.5 83.9s3.7 17.6 4 18.2C87.5 103.6 96.3 103.1 99.9 101.2 105.7 98.3 107.2 95.2 110 79.7l2.5-14.2L117.3 65.2C123.5 64.8 123.7 65.7 121.6 78.4c-2.5 14.4-4.5 21.2-7.3 24.2C113 104 112 105.3 112.2 105.5 112.4 105.6 114.3 106.7 116.5 107.8 124.5 111.9 129.8 119.6 130.7 128.5 131.7 138 127.9 143.9 119 146.9 114.5 148.4 90.2 149.3 87.4 148.1zm24.9-9.5C117.8 136.3 119.3 133.8 118.8 127.7 117.9 117 111.3 112.1 96.6 111.2L87.7 110.7 88.3 113.1C88.6 114.4 89.8 120.5 91 126.5 92.1 132.6 93.3 138.1 93.5 138.8 94.1 140.5 108.1 140.4 112.3 138.6z" id="形状" fill="#fff"/><path d="M159.5 148.4C158.4 148.1 157.2 147.5 156.7 147.1c-1-1-16.8-80.2-16.1-81.2C141.2 64.8 148 64.7 149.7 65.8 150.3 66.2 152.2 73.3 153.8 81.5L156.7 96.5 167.8 97.1c17.1 1 25.5 5.7 31.2 17.2C206.2 129.1 202.4 143.6 190.5 146.9 186.1 148.1 162.6 149.2 159.5 148.4zm27.2-11C195 131.2 191.3 114.2 180.5 108.6 177.6 107.1 174.2 106.4 167.8 106.2 162.9 106 159 106.2 159 106.7 159 107.1 160.4 114.9 162.1 123.9L165.3 140.2 174.6 139.8C182.1 139.5 184.5 139 186.7 137.4z" id="形状" fill="#fff"/><path d="M52.3 50.7C49 41.2 49.5 37.5 52.9 46.5c1.2 3.1 1.9876864 5.9098389 2.1 6.3S55.4 54.1 55.9 54.9C56.6 56 58.2 55.2 63.5 50.9 67.2 47.9 70.4 45.6 70.6 45.8 71.7 46.5 70.9 47.4 64.1 53.2 60 56.6 58.2983882 57.6981689 57.4 58.2 56.5016118 58.7018311 56.5016118 58.7018311 55.8 58.2 55 57.49737 54 55.4 52.3 50.7z" id="形状" fill="#7e7e7e"/><path d="M84 34.1C84 30.6 82.8 29 80.4 29 78.9 29 78 28.4 78 27.5 78 26.7 78.9 26 80 26 82.4 26 82.4 25.5 80.5 17 79.7 13.4 79.1 8.4 79 5.8 79 1.6 79.3 1 81.4.4 85.1-.5 89.5.3 89.8 2 90 3.1 89.2 3.5 86.8 3.5 83.9 3.5 83.5 3.8 83.3 6.5 83.1 8.2 83.8 13.1 84.8 17.5c1.7 7.9 1.7 8 5.2 8.6L93.5 26.7C94.2848943 26.7875501 94.751561 26.9875501 94.9 27.3 95 28.6 94.2 29 91.1 29h-4L87.7 32.5C88.2 35.6 88 36 86.1 36 84.7 36 84 35.4 84 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M105 34.1C105 30.6 103.8 29 101.4 29 99.9 29 99 28.4 99 27.5 99 26.7 99.9 26 101 26 103.4 26 103.4 25.5 101.5 17 100.7 13.4 100.1 8.4 1e2 5.8 1e2 1.6 100.3 1 102.4.4 106.1-.5 110.5.3 110.8 2 111 3.1 110.2 3.5 107.8 3.5 104.9 3.5 104.5 3.8 104.3 6.5 104.1 8.2 104.8 13.1 105.8 17.5c1.7 7.9 1.7 8 5.2 8.6L114.5 26.7C115.433333 26.8462934 115.9 27.0462934 115.9 27.3 116 28.6 115.2 29 112.1 29h-4L108.7 32.5C109.2 35.6 109 36 107.1 36 105.7 36 105 35.4 105 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M54.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C46.5 1.9 48.6.0 57.2.0 63.6.0 67 1.2 67 3.6 67 4.7 66.6 4.8 65.1 4c-2.7-1.4-10.4-1.3-12.4.3C51.8 4.9 51 6.6 50.9 8 50.4 13.5 50.6 13.7 57.8 14.2 66 14.9 69.5 16.4 71 20 72.3 23.2 71.2 26.3 68 28s-10.2 1.1-13.7-1.1zM67 22.7C67 19 63.6 17 57.3 17 54.4 17 52 17.3 52 17.8c0 1.1 3.1 5.4 5 7C57.9 25.5 60.2 25.9 62.8 25.7 65.1 25.4 67 26.1 67 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M126.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C118.5 1.9 120.6.0 129.2.0 135.6.0 139 1.2 139 3.6 139 4.7 138.6 4.8 137.1 4 134.4 2.6 126.7 2.7 124.7 4.3 123.8 4.9 123 6.6 122.9 8 122.4 13.5 122.6 13.7 129.8 14.2 138 14.9 141.5 16.4 143 20 144.3 23.2 143.2 26.3 140 28s-10.2 1.1-13.7-1.1zM139 22.7C139 19 135.6 17 129.3 17 126.4 17 124 17.3 124 17.8 124 18.9 127.1 23.2 129 24.8 129.9 25.5 132.2 25.9 134.8 25.7 137.1 25.4 139 26.1 139 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M153.7 26.8C151.7 18.4 149.2978 2.90464869 149.2978 2.1 149.2978 1.77371339 148.894918.241544332 150.3.1 151.705082-.0415443324 153 .4 153 2.1 153 3.2 153.7 7.2 154.6 11 156.5 19.3 161 25.2 165.5 25.4 167.5 25.5 168.6 26.1 168.8 27.3 169.1 28.6 168.4 29 165.8 29 163.2 29 161.6 28.2 159.4 25.8L156.5 22.5C155.5 19.6333333 155.133333 18.4333333 155.4 18.9 155.9 19.7 156.5 22.2 156.7 24.6 156.9 27.9 156.7 29 155.6 29 154.8 29 154 28 153.7 26.8z" id="形状" fill="url(#linearGradient-4)"/></g></g></g></svg></span>
        
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://github.com/apache/incubator-brpc/" target="_blank" ><span>GitHub</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/blog/" ><span>博客</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/docs/community/" ><span>社区</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/docs/faq/" ><span>FAQ</span></a>
			</li>
			
			
			
			<li class="nav-item dropdown d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/en/">English</a>
	
</div>
			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label="搜索本站" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    
<input type="search" class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label="搜索本站" autocomplete="off">

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav pt-2 pl-4" id="td-section-nav">
    
    <div class="nav-item dropdown d-block d-lg-none">
      

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/en/">English</a>
	
</div>
    </div>
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a>
  </li>
  <ul>
    <li class="collapse show" id="docs">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsoverview" href="/docs/overview/">简介</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/quick-start/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">开始</a>
  </li>
  <ul>
    <li class="collapse " id="docsquick-start">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsquick-startproxy" href="/docs/quick-start/proxy/">快速开始</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsquick-startistio" href="/docs/quick-start/istio/">集成 Istio</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/concept/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">架构原理</a>
  </li>
  <ul>
    <li class="collapse " id="docsconcept">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptcore-concept" href="/docs/concept/core-concept/">核心概念</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptsidecar-pattern" href="/docs/concept/sidecar-pattern/">Sidecar 模式</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconcepttraffic-hijack" href="/docs/concept/traffic-hijack/">流量劫持</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconcepttls" href="/docs/concept/tls/">TLS 安全链路</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptsmooth-upgrade" href="/docs/concept/smooth-upgrade/">MOSN 平滑升级原理解析</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptmulti-protocol" href="/docs/concept/multi-protocol/">MOSN 多协议机制解析</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptextensions" href="/docs/concept/extensions/">MOSN 扩展机制解析</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docssamples" href="/docs/samples/">工程示例</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">配置概览</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfiguration">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationclustermanager" href="/docs/configuration/clustermanager/">ClusterManager 配置</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/server/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Server 配置</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfigurationserver">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationserverrouter" href="/docs/configuration/server/router/">Router 配置</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/server/listener/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Listener 配置</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfigurationserverlistener">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationserverlistenerfilter-chain" href="/docs/configuration/server/listener/filter-chain/">FilterChain</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/server/listener/network-filter/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Network Filter</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfigurationserverlistenernetwork-filter">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationserverlistenernetwork-filterproxy" href="/docs/configuration/server/listener/network-filter/proxy/">proxy</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationserverlistenernetwork-filterconnection-manager" href="/docs/configuration/server/listener/network-filter/connection-manager/">connection_manager</a>
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/trace/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Trace 配置</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfigurationtrace">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationtraceskywalking" href="/docs/configuration/trace/skywalking/">SkyWalking 配置</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationcustom" href="/docs/configuration/custom/">自定义配置</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/dev/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">开发指南</a>
  </li>
  <ul>
    <li class="collapse show" id="docsdev">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsdevrelease" href="/docs/dev/release/">版本发布 介绍</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsdevdubbo-integrate" href="/docs/dev/dubbo-integrate/">Dubbo 集成</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page  active" id="m-docsdevfeaturegate-introduce" href="/docs/dev/featuregate-introduce/">Featuregate 介绍</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/contribute/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">贡献文档</a>
  </li>
  <ul>
    <li class="collapse " id="docscontribute">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscontributegithub" href="/docs/contribute/github/">文档贡献指南</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscontributecreating-pages" href="/docs/contribute/creating-pages/">创建页面</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscontributestyle-guide" href="/docs/contribute/style-guide/">样式指南</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsfaq" href="/docs/faq/">FAQ</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscommunity" href="/docs/community/">社区</a>
      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">





<a href="https://github.com/apache/incubator-brpc-website/edit/master/content/zh/docs/dev/featuregate-introduce/index.md" target="_blank"><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
<a href="https://github.com/apache/incubator-brpc-website/issues/new?title=Featuregate%20%e4%bb%8b%e7%bb%8d" target="_blank"><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>


<a href="https://github.com/apache/incubator-brpc/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a>

</div>






<nav id="TableOfContents">
  <ul>
    <li><a href="#featuregate-介绍">Featuregate 介绍</a></li>
    <li><a href="#基于-featuregate-进行开发">基于 featuregate 进行开发</a>
      <ul>
        <li><a href="#featuregate-实现">Featuregate 实现</a></li>
        <li><a href="#featuregate-的使用">Featuregate 的使用</a></li>
        <li><a href="#faq">FAQ</a></li>
      </ul>
    </li>
  </ul>
</nav>



          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		










<li class="breadcrumb-item" >
	<a href="/docs/">文档</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/dev/">开发指南</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/docs/dev/featuregate-introduce/">Featuregate 介绍</a>
</li>

	</ol>
</nav	>


            
<div class="td-content">
	<h1>Featuregate 介绍</h1>
	<div class="lead">本页介绍了 MOSN 的 featuregate。</div>
	<h2 id="featuregate-介绍">Featuregate 介绍</h2>
<p>在 MOSN 中，存在一些功能需要在启动时决定是否开启的，为了满足这种需求，MOSN 推出了 featuregate（功能开关）的能力。</p>
<p>Featuregate 描述了一组 MOSN 中需要开启 / 关闭的 feature 状态，每个 feature 都有自己默认的状态，每个 MOSN 版本支持的 feature、feature 默认的版本都有所不同；featuregate 的描述用一个字符串表示，按照<code>${feature}=${bool}</code>的方式，用逗号进行分割：</p>
<pre><code>// 通用模版
./mosn start -c ${config path} -f ${feature gates description}
// 示例
./mosn start -c mosn_config.json -f &quot;auto_config=true,XdsMtlsEnable=true&quot;
</code></pre><p>Featuregate 不仅仅是提供了一种功能切换的能力，同时也提供了一种可扩展的开发机制，基于 MOSN 进行二次开发时，可以使用 featuregate 做到如下的功能：</p>
<ul>
<li>功能切换的能力，可以控制某个 feature 的开启 / 关闭</li>
<li>feature 之间的依赖关系管理，包括 feature 之间的启动顺序依赖、开启 / 关闭状态的依赖等
<ul>
<li>举例说明，基于 MOSN 实现两个 feature，分别为 A 和 B，需要在 A 初始化完成以后，B 会使用 A 初始化的结果进行初始化，这就是 B 依赖 A，当 feature A 处于 Disable 状态时，B 显然也会处于 Disable 或者需要作出对应的“降级”； feature gate 框架提供了一种简单的方式，可以更加专注于 feature 的开发，而不用去管理对应的启动与依赖</li>
</ul>
</li>
</ul>
<p>基于 featuregate 的框架，在 MOSN 中进行不同 feature 的二次开发，是 featuregate 框架最主要的目的。</p>
<h2 id="基于-featuregate-进行开发">基于 featuregate 进行开发</h2>
<h3 id="featuregate-实现">Featuregate 实现</h3>
<p>首先，我们来看一下，featuregate 框架提供了哪些接口：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#8f5902;font-style:italic">// 返回一个 Feature 当前的状态，true 表示 enable，false 表示 disable
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#000">Feature</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span>
<span style="color:#8f5902;font-style:italic">// “订阅”一个 Feature，并且返回其订阅完成以后的状态。
</span><span style="color:#8f5902;font-style:italic">// 当订阅的 Feature 初始化完成以后，会返回其是否 Enable。
</span><span style="color:#8f5902;font-style:italic">// 如果订阅的 Feature 是 Disable 的，会直接返回 false；如果在订阅的 timeout 期间，Feature 依然没有
</span><span style="color:#8f5902;font-style:italic">// 初始化完成，那么会返回订阅超时的错误，如果 timeout 小于等于 0，则没有订阅超时
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Subscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#000">Feature</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">timeout</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#8f5902;font-style:italic">// 设置 feature gates 的状态，value 为一个完整的 feature gates 描述
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
<span style="color:#8f5902;font-style:italic">// 设置 feature gates 的状态，其中 map 的 key 为 feature 的 key，value 是期望设置的 feature 状态
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">SetFromMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
<span style="color:#8f5902;font-style:italic">// 新注册一个 feature 到 feature gate 中
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">AddFeatureSpec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#000">Feature</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">spec</span> <span style="color:#000">FeatureSpec</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
<span style="color:#8f5902;font-style:italic">// 设置一个 feature 的状态
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">SetFeatureState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#000">Feature</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">enable</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
<span style="color:#8f5902;font-style:italic">// 开启初始化 feature
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">StartInit</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#8f5902;font-style:italic">// 等待所有的 feature 初始化结束
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">WaitInitFinsh</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span>
</code></pre></div><p>这其中，StartInit 和 WaitInitFinsh 是由 MOSN 框架进行调用，基于 MOSN 进行二次开发时无须关注和调用；通常情况下，Set 和 SetFromMap 也无须关注。所有的上述接口，都是由框架下默认的一个不可导出的全局 featuregate 对象暴露，在没有极为特殊需求的场景下（如编写单元测试），不需要额外生成 FeatureGate 对象，使用默认的即可。</p>
<p>接下来，我们看一下 featuregate 的实现：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">knownFeatureSpec</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">FeatureSpec</span>
        <span style="color:#000">once</span>    <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Once</span>
        <span style="color:#000">channel</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Feature</span> <span style="color:#204a87;font-weight:bold">string</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">FeatureGate</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// lock guards writes to known, enabled, and reads/writes of closed
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">lock</span>  <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
        <span style="color:#000">known</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Feature</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">knownFeatureSpec</span>
        <span style="color:#8f5902;font-style:italic">// inited is set to true when StartInit is called.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">inited</span> <span style="color:#204a87;font-weight:bold">bool</span>
        <span style="color:#000">wg</span>     <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span>
        <span style="color:#000">once</span>   <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Once</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Featuregate 包含了一个 map，用于记录所有被支持的 feature；一个<code>inited</code>状态标，表示 featuregate 是否已经完成了初始化；<code>once</code>用于确保 featuregate 的初始化只执行一次，<code>WaitGroup</code>则用于同步 feature 初始化的结果；一个<code>Mutex</code>用于并发保护。
按照 featuregate 的设计，不同的 feature 是可以通过<code>Add</code>的方式新增，以及不同的<code>Set</code>方法改变状态的，而不同 feature 的初始化<code>Init</code>函数都会统一执行，因此一旦执行完<code>Init</code>，则不再允许新增 feature、修改 feature 状态；因此我们需要一个<code>inited</code>的标记来记录这个行为。
<code>knownFeatureSpec</code>是一个不可导出的结构体，用于对表示不同 feature 的<code>FeatureSpec</code>封装，其中的<code>once</code>和<code>channel</code>均是用于 featuregate 中订阅和初始化使用，在此不做详细说明。
下面，我们来看一下<code>FeatureSpec</code>的定义，这也是我们基于 featuregate 框架进行开发的核心数据结构。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">prerelease</span> <span style="color:#204a87;font-weight:bold">string</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span>
        <span style="color:#8f5902;font-style:italic">// Values for PreRelease.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">Alpha</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">prerelease</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ALPHA&#34;</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000">Beta</span>  <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">prerelease</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;BETA&#34;</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000">GA</span>    <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">prerelease</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">FeatureSpec</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// Default is the default enablement state for the feature
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">Default</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">bool</span>
        <span style="color:#8f5902;font-style:italic">// LockToDefault indicates that the feature is locked to its default and cannot be changed
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">LockToDefault</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">bool</span>
        <span style="color:#8f5902;font-style:italic">// SetState sets the enablement state for the feature
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">SetState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">enable</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#8f5902;font-style:italic">// State indicates the feature enablement
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">State</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">bool</span>
        <span style="color:#8f5902;font-style:italic">// InitFunc used to init process when StartInit is invoked
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">InitFunc</span><span style="color:#000;font-weight:bold">()</span>
        <span style="color:#8f5902;font-style:italic">// PreRelease indicates the maturity level of the feature
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">PreRelease</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">prerelease</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li><code>prerelease</code> 是不可导出的定义，有三个约定的导出变量可以使用，相当于传统语言的 Enum 类型，用于描述 feature 的信息，没有明确的作用</li>
<li><code>FeatureSpec</code>可以自行实现，同时多数情况下可以用框架实现的<code>BaseFeatureSpec</code>，或者基于<code>BaseFeatureSpec</code>进行封装；如注释描述，通常情况下只需要额外封装实现一个<code>InitFunc</code>函数即可</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#8f5902;font-style:italic">// BaseFeatureSpec is a basic implementation of FeatureSpec.
</span><span style="color:#8f5902;font-style:italic">// Usually, a feature spec just need an init func.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">BaseFeatureSpec</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// 默认状态
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">DefaultValue</span>    <span style="color:#204a87;font-weight:bold">bool</span>
        <span style="color:#8f5902;font-style:italic">// 是否可修改状态，如果为 true，说明这个 feature 只能保持默认状态
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// 一般情况下设置这个为 true 的时候，default 也是 true
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// 这种 feature 主要会用于做为其他 feature 的“基础依赖”
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">IsLockedDefault</span> <span style="color:#204a87;font-weight:bold">bool</span>
        <span style="color:#000">PreReleaseValue</span> <span style="color:#000">prerelease</span>
        <span style="color:#000">stateValue</span>      <span style="color:#204a87;font-weight:bold">bool</span>  <span style="color:#8f5902;font-style:italic">// stateValue shoule be setted by SetState
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">inited</span>          <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#8f5902;font-style:italic">// inited cannot be setted
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="featuregate-的使用">Featuregate 的使用</h3>
<p>了解了 featuregate 的基本实现，就可以考虑使用 featuregate 进行基本的编程扩展了。下面会介绍几种 featuregate 的使用场景，以及如何编写 feature。</p>
<h4 id="1-基本的全局开关">1. 基本的“全局”开关</h4>
<p>对于 feature 切换最基本的使用场景，就是使用一个类似“全局变量”进行控制，通过<code>if</code>条件判断执行不同的逻辑。使用 featuregate 框架实现这种能力，可以把控制 feature 切换的参数全部统一到启动参数中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">featureName</span> <span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Feature</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;simple_feature&#34;</span>
<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">fs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BaseFeatureSpec</span><span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">DefaultValue</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFeatureSpec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">featureName</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">myfunc</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">featureName</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">dosth</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">dosth2</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h4 id="2-需要进行初始化操作">2. 需要进行“初始化”操作</h4>
<p>通过封装扩展 InitFunc 函数，让相关的初始化工作在 MOSN 启动时统一完成，如果 feature 处于 disable 状态，那么 InitFunc 不会执行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">featureName</span> <span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Feature</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;init_feature&#34;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">MyFeature</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">BaseFeatureSpec</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">MyFeature</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">InitFunc</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">doInit</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#8f5902;font-style:italic">// 其他的类似 1.
</span></code></pre></div><h4 id="3-feature-之间存在依赖关系">3. Feature 之间存在依赖关系</h4>
<p>这个功能是 featuregate 框架提供的最重要的能力，可以方便的解决下面的场景：</p>
<ul>
<li>假设我们存在四个独立的组件（feature），分别是 A、B、C，D</li>
<li>B 和 C 的启动都依赖于 A，即首先要 A 启动完成，然后 B 和 C 才能启动完成；D 依赖于 B，必须 B 启动完成，D 才可以启动</li>
<li>如果 A 没有启动，B 就不能启动，而 C 存在一种降级方案，依然可以继续工作</li>
<li>四个 feature 在 featuregate 框架下可各自实现，如下</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">FeatureA</span> <span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Feature</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;A&#34;</span>

<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">fs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BaseFeatureSpec</span><span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">DefaultValue</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFeatureSpec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">FeatureA</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">FeatureB</span> <span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Feature</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;B&#34;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">FB</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">BaseFeatureSpec</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">FB</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">InitFunc</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">enabled</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Subscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">FeatureA</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">enabled</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 如果 FeatureA 没有开启，则 FeatureB 也不开启
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">FeatureC</span>  <span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Feature</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;C&#34;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">FC</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">BaseFeatureSpec</span>
    <span style="color:#000">mode</span> <span style="color:#204a87;font-weight:bold">int32</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">FC</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">InitFunc</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">enabled</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Subscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">FeatureA</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">enabled</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mode</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#8f5902;font-style:italic">// 降级模式
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">enabled</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mode</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#8f5902;font-style:italic">// 正常模式
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">FC</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">MyFunc</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">dosth</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">dosth2</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">FeatureD</span> <span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Feature</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;D&#34;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">FD</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">BaseFeatureSpec</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">FD</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">InitFunc</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">enabled</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">featuregate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Subscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">FeatureB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 不超时，一定要等待 B 结束
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">enabled</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">FD</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="faq">FAQ</h3>
<h4 id="为什么不使用配置的方式而要使用-featuregate">为什么不使用配置的方式，而要使用 featuregate?</h4>
<ul>
<li>配置文件需要进行解析，featuregate 更有利于扩展能力的实现</li>
<li>有的 feature 需要判断的时机，比配置文件解析要早，甚至可能影响配置解析的逻辑</li>
</ul>

	
	
	<div class="text-muted mt-5 pt-3 border-top">修改于 2020年7月27日: <a  href="https://github.com/apache/incubator-brpc-website/commit/9df005ed5e16d206723cf58b72c4599f8403451c">redirect zh url (9df005e)</a>
</div>
</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-12 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" href="https://github.com/apache/incubator-brpc">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The bRPC Authors 保留所有权利</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>






<script src="/js/main.min.170adf90fd476d5f9243ed2e727149abe8d9fe364587fe943765d47375bbd1ad.js" integrity="sha256-FwrfkP1HbV&#43;SQ&#43;0ucnFJq&#43;jZ/jZFh/6UN2XUc3W70a0=" crossorigin="anonymous"></script>





  </body>
</html>