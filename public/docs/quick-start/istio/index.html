<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.86.0" />
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>MOSN 作为 Istio 的数据平面 | bRPC</title><meta property="og:title" content="MOSN 作为 Istio 的数据平面" />
<meta property="og:description" content="本文将介绍如何使用 MOSN 在 Istio 框架下搭建 Service Mesh 的开发环境，并验证 MOSN 的一些基础路由能力、负载均衡能力等。
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://brpc.incubator.apache.org/docs/quick-start/istio/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2020-03-19T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-02-08T19:15:45-06:00" /><meta property="og:site_name" content="bRPC" />

<meta itemprop="name" content="MOSN 作为 Istio 的数据平面">
<meta itemprop="description" content="本文将介绍如何使用 MOSN 在 Istio 框架下搭建 Service Mesh 的开发环境，并验证 MOSN 的一些基础路由能力、负载均衡能力等。
"><meta itemprop="datePublished" content="2020-03-19T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-02-08T19:15:45-06:00" />
<meta itemprop="wordCount" content="1038">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MOSN 作为 Istio 的数据平面"/>
<meta name="twitter:description" content="本文将介绍如何使用 MOSN 在 Istio 框架下搭建 Service Mesh 的开发环境，并验证 MOSN 的一些基础路由能力、负载均衡能力等。
"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-93485976-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




<link rel="preload" href="/scss/main.min.6c022a2695e1b7248646a4d8e9854baa2e7b3dec122dbfd8d0a958f44f5392f8.css" as="style">
<link href="/scss/main.min.6c022a2695e1b7248646a4d8e9854baa2e7b3dec122dbfd8d0a958f44f5392f8.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>





    <title>MOSN 作为 Istio 的数据平面 | bRPC</title>
  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg width="303" height="259" viewBox="0 0 303 259" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>brpc_logo.svg</title><defs><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-2"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-3"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-4"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="椭圆形" fill="#58b8ff" cx="23.5" cy="62.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="279.5" cy="60.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="119" cy="26" r="26"/><rect id="矩形" fill="#58b8ff" transform="translate(78.021813, 41.967662) rotate(-22.000000) translate(-78.021813, -41.967662)" x="30.0218125" y="35.9676616" width="96" height="12"/><rect id="矩形" fill="#58b8ff" transform="translate(201.451088, 44.299021) rotate(13.000000) translate(-201.451088, -44.299021)" x="138.951088" y="38.2990214" width="125" height="12"/><g id="brpc-logo" transform="translate(11.000000, 104.000000)" fill-rule="nonzero"><g id="编组" transform="translate(138.000000, 77.419111) scale(-1, 1) rotate(-180.000000) translate(-138.000000, -77.419111) translate(0.000000, 0.000000)"><path d="M18.8 154.3C17.8 154.1 17 153.8 17 153.6 17 153.5 13.2 134.3 8.5 111 3.8 87.7-205355861e-22 68-205355861e-22 67.4-205355861e-22 65.9 2.6 65.3 5.7 65.8 7.3 66.1 8.1 67.2 8.6 69.6 9.3 73.5 10 73.8 11.7 71.1 15 65.9 28.8 63.2 36.4 66.4 48.9 71.6 57.7 89.6 56.8 108.1c-.5 10-2.5 14.5-7.8 17.1C44.5 127.5 36.6 127.5 31.4 125.1 27 123.1 20.8814242 116.827994 20 115.8 19.8268414 115.598047 19.5 115 19 115.2 18.3 115.4 18.3 116.5 19 118.7 19.6 120.4 21.6 129 23.4 137.8l3.3 16L24.6 154.4C22.3 155 21.4 155 18.8 154.3zm24.6146505-36.885789c1.7578246-1.326292 2.0864078-1.825452 2.4530432-2.642066S46.8138702 112.705545 47.1008328 111.513935C48.333925 109.104457 47.0101697 95.2413285 45.0724535 89.7736686 41.197021 79.2090375 34.9434822 73 28.2495534 73c-4.5800565.0-7.4866309 1.5754274-11.5382193 6.1163653-1.6734822 1.8534441-1.598743 2.8514069-2.0391331 4.4738936C14.2318109 85.2127457 15.3810952 94.5991493 17.4068894 98.6767262 18.5085881 100.995054 18.5085881 100.995054 20.3179492 104.427606 20.9381193 105.604136 23.3268821 108.69306 24.5063492 109.790864c1.2349847 1.149478 2.6574201 2.834639 3.7432042 3.921533 1.1506404 1.15181600000001 4.2465085 3.084017 5.3028342 3.701814 1.4321645.837608000000003 2.774919 1.362015 4.0282636 1.573221C40.1349135 119.080104 41.2462694 118.670624 43.4146505 117.414211z" id="形状" fill="url(#linearGradient-1)"/><path d="M248.7 148.9C241 147.8 232.2 143 226.1 136.5c-14.2-15-20-43.1-12.1-58.6C216.6 72.9 223.2 67.5 228.5 66 235.2 64.1 249.3 65.1 255.7 67.9 258.6 69.2 261.4 70.8 262.1 71.6 263.7 73.5 265 79.9 263.9 80.6 263.4 80.9 260 79.6 256.3 77.8 243 71.3 230.4 73.3 225.1 82.9 218.5 94.9 223.7 119.3 235.5 131.5 245.8 142 257.4 142.9 271.3 134.2 273.7 132.7 274.2 132.7 275 134 275.5 134.8 276 137.2 276 139.2 276 142.2 275.5 143.2 272.8 144.8 266.2 148.7 257.7 150.2 248.7 148.9z" id="路径" fill="#fff"/><path d="M87.4 148.1C86.2 147.6 84.9 146.7 84.6 146.1 83.6 144.5 68.1 66.6 68.7 65.8c.599999999999994-1 7.5-1 9 0C78.4 66.3 80.6 74.4 82.5 83.9s3.7 17.6 4 18.2C87.5 103.6 96.3 103.1 99.9 101.2 105.7 98.3 107.2 95.2 110 79.7l2.5-14.2L117.3 65.2C123.5 64.8 123.7 65.7 121.6 78.4c-2.5 14.4-4.5 21.2-7.3 24.2C113 104 112 105.3 112.2 105.5 112.4 105.6 114.3 106.7 116.5 107.8 124.5 111.9 129.8 119.6 130.7 128.5 131.7 138 127.9 143.9 119 146.9 114.5 148.4 90.2 149.3 87.4 148.1zm24.9-9.5C117.8 136.3 119.3 133.8 118.8 127.7 117.9 117 111.3 112.1 96.6 111.2L87.7 110.7 88.3 113.1C88.6 114.4 89.8 120.5 91 126.5 92.1 132.6 93.3 138.1 93.5 138.8 94.1 140.5 108.1 140.4 112.3 138.6z" id="形状" fill="#fff"/><path d="M159.5 148.4C158.4 148.1 157.2 147.5 156.7 147.1c-1-1-16.8-80.2-16.1-81.2C141.2 64.8 148 64.7 149.7 65.8 150.3 66.2 152.2 73.3 153.8 81.5L156.7 96.5 167.8 97.1c17.1 1 25.5 5.7 31.2 17.2C206.2 129.1 202.4 143.6 190.5 146.9 186.1 148.1 162.6 149.2 159.5 148.4zm27.2-11C195 131.2 191.3 114.2 180.5 108.6 177.6 107.1 174.2 106.4 167.8 106.2 162.9 106 159 106.2 159 106.7 159 107.1 160.4 114.9 162.1 123.9L165.3 140.2 174.6 139.8C182.1 139.5 184.5 139 186.7 137.4z" id="形状" fill="#fff"/><path d="M52.3 50.7C49 41.2 49.5 37.5 52.9 46.5c1.2 3.1 1.9876864 5.9098389 2.1 6.3S55.4 54.1 55.9 54.9C56.6 56 58.2 55.2 63.5 50.9 67.2 47.9 70.4 45.6 70.6 45.8 71.7 46.5 70.9 47.4 64.1 53.2 60 56.6 58.2983882 57.6981689 57.4 58.2 56.5016118 58.7018311 56.5016118 58.7018311 55.8 58.2 55 57.49737 54 55.4 52.3 50.7z" id="形状" fill="#7e7e7e"/><path d="M84 34.1C84 30.6 82.8 29 80.4 29 78.9 29 78 28.4 78 27.5 78 26.7 78.9 26 80 26 82.4 26 82.4 25.5 80.5 17 79.7 13.4 79.1 8.4 79 5.8 79 1.6 79.3 1 81.4.4 85.1-.5 89.5.3 89.8 2 90 3.1 89.2 3.5 86.8 3.5 83.9 3.5 83.5 3.8 83.3 6.5 83.1 8.2 83.8 13.1 84.8 17.5c1.7 7.9 1.7 8 5.2 8.6L93.5 26.7C94.2848943 26.7875501 94.751561 26.9875501 94.9 27.3 95 28.6 94.2 29 91.1 29h-4L87.7 32.5C88.2 35.6 88 36 86.1 36 84.7 36 84 35.4 84 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M105 34.1C105 30.6 103.8 29 101.4 29 99.9 29 99 28.4 99 27.5 99 26.7 99.9 26 101 26 103.4 26 103.4 25.5 101.5 17 100.7 13.4 100.1 8.4 1e2 5.8 1e2 1.6 100.3 1 102.4.4 106.1-.5 110.5.3 110.8 2 111 3.1 110.2 3.5 107.8 3.5 104.9 3.5 104.5 3.8 104.3 6.5 104.1 8.2 104.8 13.1 105.8 17.5c1.7 7.9 1.7 8 5.2 8.6L114.5 26.7C115.433333 26.8462934 115.9 27.0462934 115.9 27.3 116 28.6 115.2 29 112.1 29h-4L108.7 32.5C109.2 35.6 109 36 107.1 36 105.7 36 105 35.4 105 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M54.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C46.5 1.9 48.6.0 57.2.0 63.6.0 67 1.2 67 3.6 67 4.7 66.6 4.8 65.1 4c-2.7-1.4-10.4-1.3-12.4.3C51.8 4.9 51 6.6 50.9 8 50.4 13.5 50.6 13.7 57.8 14.2 66 14.9 69.5 16.4 71 20 72.3 23.2 71.2 26.3 68 28s-10.2 1.1-13.7-1.1zM67 22.7C67 19 63.6 17 57.3 17 54.4 17 52 17.3 52 17.8c0 1.1 3.1 5.4 5 7C57.9 25.5 60.2 25.9 62.8 25.7 65.1 25.4 67 26.1 67 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M126.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C118.5 1.9 120.6.0 129.2.0 135.6.0 139 1.2 139 3.6 139 4.7 138.6 4.8 137.1 4 134.4 2.6 126.7 2.7 124.7 4.3 123.8 4.9 123 6.6 122.9 8 122.4 13.5 122.6 13.7 129.8 14.2 138 14.9 141.5 16.4 143 20 144.3 23.2 143.2 26.3 140 28s-10.2 1.1-13.7-1.1zM139 22.7C139 19 135.6 17 129.3 17 126.4 17 124 17.3 124 17.8 124 18.9 127.1 23.2 129 24.8 129.9 25.5 132.2 25.9 134.8 25.7 137.1 25.4 139 26.1 139 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M153.7 26.8C151.7 18.4 149.2978 2.90464869 149.2978 2.1 149.2978 1.77371339 148.894918.241544332 150.3.1 151.705082-.0415443324 153 .4 153 2.1 153 3.2 153.7 7.2 154.6 11 156.5 19.3 161 25.2 165.5 25.4 167.5 25.5 168.6 26.1 168.8 27.3 169.1 28.6 168.4 29 165.8 29 163.2 29 161.6 28.2 159.4 25.8L156.5 22.5C155.5 19.6333333 155.133333 18.4333333 155.4 18.9 155.9 19.7 156.5 22.2 156.7 24.6 156.9 27.9 156.7 29 155.6 29 154.8 29 154 28 153.7 26.8z" id="形状" fill="url(#linearGradient-4)"/></g></g></g></svg></span>
        
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://github.com/apache/incubator-brpc/" target="_blank" ><span>GitHub</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/blog/" ><span>博客</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/docs/community/" ><span>社区</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/docs/faq/" ><span>FAQ</span></a>
			</li>
			
			
			
			<li class="nav-item dropdown d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/en/">English</a>
	
</div>
			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label="搜索本站" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    
<input type="search" class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label="搜索本站" autocomplete="off">

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav pt-2 pl-4" id="td-section-nav">
    
    <div class="nav-item dropdown d-block d-lg-none">
      

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/en/">English</a>
	
</div>
    </div>
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a>
  </li>
  <ul>
    <li class="collapse show" id="docs">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsoverview" href="/docs/overview/">简介</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/quick-start/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">开始</a>
  </li>
  <ul>
    <li class="collapse show" id="docsquick-start">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsquick-startproxy" href="/docs/quick-start/proxy/">快速开始</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page  active" id="m-docsquick-startistio" href="/docs/quick-start/istio/">集成 Istio</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/concept/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">架构原理</a>
  </li>
  <ul>
    <li class="collapse " id="docsconcept">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptcore-concept" href="/docs/concept/core-concept/">核心概念</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptsidecar-pattern" href="/docs/concept/sidecar-pattern/">Sidecar 模式</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconcepttraffic-hijack" href="/docs/concept/traffic-hijack/">流量劫持</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconcepttls" href="/docs/concept/tls/">TLS 安全链路</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptsmooth-upgrade" href="/docs/concept/smooth-upgrade/">MOSN 平滑升级原理解析</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptmulti-protocol" href="/docs/concept/multi-protocol/">MOSN 多协议机制解析</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconceptextensions" href="/docs/concept/extensions/">MOSN 扩展机制解析</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docssamples" href="/docs/samples/">工程示例</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">配置概览</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfiguration">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationclustermanager" href="/docs/configuration/clustermanager/">ClusterManager 配置</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/server/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Server 配置</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfigurationserver">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationserverrouter" href="/docs/configuration/server/router/">Router 配置</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/server/listener/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Listener 配置</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfigurationserverlistener">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationserverlistenerfilter-chain" href="/docs/configuration/server/listener/filter-chain/">FilterChain</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/server/listener/network-filter/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Network Filter</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfigurationserverlistenernetwork-filter">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationserverlistenernetwork-filterproxy" href="/docs/configuration/server/listener/network-filter/proxy/">proxy</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationserverlistenernetwork-filterconnection-manager" href="/docs/configuration/server/listener/network-filter/connection-manager/">connection_manager</a>
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/configuration/trace/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Trace 配置</a>
  </li>
  <ul>
    <li class="collapse " id="docsconfigurationtrace">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationtraceskywalking" href="/docs/configuration/trace/skywalking/">SkyWalking 配置</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsconfigurationcustom" href="/docs/configuration/custom/">自定义配置</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/dev/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">开发指南</a>
  </li>
  <ul>
    <li class="collapse " id="docsdev">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsdevrelease" href="/docs/dev/release/">版本发布 介绍</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsdevdubbo-integrate" href="/docs/dev/dubbo-integrate/">Dubbo 集成</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsdevfeaturegate-introduce" href="/docs/dev/featuregate-introduce/">Featuregate 介绍</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/contribute/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">贡献文档</a>
  </li>
  <ul>
    <li class="collapse " id="docscontribute">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscontributegithub" href="/docs/contribute/github/">文档贡献指南</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscontributecreating-pages" href="/docs/contribute/creating-pages/">创建页面</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscontributestyle-guide" href="/docs/contribute/style-guide/">样式指南</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsfaq" href="/docs/faq/">FAQ</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscommunity" href="/docs/community/">社区</a>
      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">





<a href="https://github.com/apache/incubator-brpc-website/edit/master/content/zh/docs/quick-start/istio/index.md" target="_blank"><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
<a href="https://github.com/apache/incubator-brpc-website/issues/new?title=MOSN%20%e4%bd%9c%e4%b8%ba%20Istio%20%e7%9a%84%e6%95%b0%e6%8d%ae%e5%b9%b3%e9%9d%a2" target="_blank"><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>


<a href="https://github.com/apache/incubator-brpc/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a>

</div>






<nav id="TableOfContents">
  <ul>
    <li><a href="#mosn-与-istio-的关系">MOSN 与 Istio 的关系</a></li>
    <li><a href="#mosn-与-istio-的-proxyv2-镜像-build-方法">MOSN 与 Istio 的 proxyv2 镜像 build 方法</a></li>
  </ul>

  <ul>
    <li><a href="#准备工作">准备工作</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#部署istio与mosn">部署Istio与MOSN</a>
      <ul>
        <li><a href="#安装-istio">安装 Istio</a></li>
        <li><a href="#设置-mosn-作为-istio-的-sidecar">设置 MOSN 作为 Istio 的 Sidecar</a></li>
        <li><a href="#修改-prometheus-deployment">修改 prometheus deployment</a></li>
        <li><a href="#验证安装">验证安装</a></li>
      </ul>
    </li>
    <li><a href="#bookinfo-示例">Bookinfo 示例</a>
      <ul>
        <li><a href="#bookinfo-实验">BookInfo 实验</a></li>
        <li><a href="#卸载-bookinfo">卸载 BookInfo</a></li>
      </ul>
    </li>
    <li><a href="#卸载-istio">卸载 Istio</a></li>
  </ul>
</nav>



          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		










<li class="breadcrumb-item" >
	<a href="/docs/">文档</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/quick-start/">开始</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/docs/quick-start/istio/">集成 Istio</a>
</li>

	</ol>
</nav	>


            
<div class="td-content">
	<h1>MOSN 作为 Istio 的数据平面</h1>
	<div class="lead">本文将介绍如何使用 MOSN 在 Istio 框架下搭建 Service Mesh 的开发环境，并验证 MOSN 的一些基础路由能力、负载均衡能力等。</div>
	

<div class="pageinfo pageinfo-primary">
<p>MOSN 已通过 Istio 1.5.2 的 <code>BookInfo</code> 测试，关于最新版 Istio 的支持情况可关注 <a href="https://github.com/mosn/community/blob/master/wg-istio.md">MOSN Istio WG</a>。</p>

</div>

<p>本文介绍的内容将包括 :</p>
<ul>
<li>MOSN 与 Istio 的关系</li>
<li>MOSN 与 Istio 的 proxyv2 镜像 build 方法</li>
<li>准备工作</li>
<li>部署 Istio 与 MOSN</li>
<li>Bookinfo 实验</li>
</ul>
<h2 id="mosn-与-istio-的关系">MOSN 与 Istio 的关系</h2>
<p>我们曾在 <a href="../../overview">MOSN 介绍</a>中介绍过，MOSN 是一款采用 Go 语言开发的 Service Mesh 数据平面代理。</p>
<p>下图是 Istio 整体框架下，MOSN 的工作示意图。</p>
<div align=center><img src="mosn-with-service-mesh.svg" width = "450" height = "400" alt="MOSN 介绍" /></div>
<h2 id="mosn-与-istio-的-proxyv2-镜像-build-方法">MOSN 与 Istio 的 proxyv2 镜像 build 方法</h2>
<p>MOSN 提供了如下两种方式来构建 Istio 的 proxyv2 镜像，如果只有 MOSN 代码发生变化，则推荐使用方式二。</p>
<h1 id="方式一更新-istio-版本">方式一（更新 Istio 版本）</h1>
<p>1、下载对应的 Istio 版本，当前 MOSN 的 <a href="https://github.com/mosn/mosn">master</a> 分支是支持 istio 1.5.2 ，<a href="https://github.com/mosn/mosn/tree/feature-istio_adapter">feature-istio_adapter</a> 分支是支持 istio 1.7.x。
2、下载完 Istio 代码后，进入到 istio 目录执行如下命令：
注意：在执行如下命令前，还需要做一些准备工作，将对应的 <code>mosn</code> 版本编译为二进制后压缩为 <code>mosn.tgz</code> 并上传至对应的存储服务中（如 github），另外 macos 的也得编译一份 <code>mosn-macos.tar.gz</code> ：</p>
<pre><code>ISTIO_ENVOY_VERSION=v0.15.0                                                                            # 对应 mosn 的版本
ISTIO_ENVOY_RELEASE_URL=https://github.com/mosn/mosn/releases/download/0.15.0/mosn.tgz                 # 对应 Linux 环境下的二进制压缩包下载路径（存储路径需自定义）
ISTIO_ENVOY_MACOS_RELEASE_URL=https://github.com/mosn/mosn/releases/download/0.15.0/mosn-macos.tar.gz  # 对应 Macos 环境下的二进制压缩包下载路径
ISTIO_ENVOY_MACOS_RELEASE_NAME=mosn-0.15.0                                                             # 设置 macos 的 sidecar 名称
SIDECAR=mosn                                                                                           # 设置 istio 的 sidecar 为 mosn
make docker.proxyv2                                                                                    # 编译构建 proxv2 镜像
</code></pre><p>另外由于目前 istio 默认在构建 <code>proxyv2</code> image 的时候会默认加载 <code>wasm</code>，所以需要显示的在其编译脚本里面注释掉 <code>wasm</code> 相关的编译内容：</p>
<pre><code>bin/init.sh
bin/update_proxy.sh
tools/istio-docker.mk
</code></pre><p>3、将新构建的 proxyv2 镜像打上对应的版本 tag</p>
<pre><code>docker images | grep proxyv2                                                                           # 找到上一步 build 出来的 image，如名称为${PROXYV2} 版本为 ${TAG}
docker tag ${PROXYV2}:${TAG}  mosnio/proxyv2:${MOSNVERSION}                                            # ${MOSNVERSION}代码 MOSN 版本 ，其值是 `cat ./VERSION` 的输出

</code></pre><h1 id="方式二更新-mosn-版本">方式二（更新 MOSN 版本）</h1>
<p>将编译好的 <code>mosn</code> 二进制拷贝到当前目录并在当前目录增加 <code>Dockerfile</code> 文件,其文件内容如下：</p>
<pre><code>FROM mosnio/proxyv2:1.5.2-mosn
COPY mosn /usr/local/bin/mosn
</code></pre><p>然后在当前目录执行如下命令：</p>
<pre><code>docker build --no-cache --rm -t mosnio/proxyv2:${MOSNVERSION} ./
</code></pre><p>其中 <code>${MOSNVERSION}</code> 的值是 <code>cat ./VERSION</code> 的输出，当执行完成后就会在本地生成一个 <code>mosnio/proxyv2</code> 镜像。</p>
<h2 id="准备工作">准备工作</h2>
<p>本文以 macOS 为例，其他环境可以安装对应版本的软件。</p>
<h4 id="安装-hyperkit">安装 hyperkit</h4>
<p>先安装 <a href="https://store.docker.com/editions/community/docker-ce-desktop-mac">docker-for-mac</a>，之后<a href="https://github.com/kubernetes/minikube/blob/master/docs/drivers.md">安装驱动</a></p>
<h4 id="安装-docker">安装 docker</h4>
<p>下载软件包安装，或者使用如下的命令安装。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ brew cask install docker
</code></pre></div><h4 id="安装驱动">安装驱动</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -LO https://storage.googleapis.com/minikube/releases/latest/docker-machine-driver-hyperkit <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chmod +x docker-machine-driver-hyperkit <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo mv docker-machine-driver-hyperkit /usr/local/bin/ <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo chown root:wheel /usr/local/bin/docker-machine-driver-hyperkit <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo chmod u+s /usr/local/bin/docker-machine-driver-hyperkit
</code></pre></div><h4 id="安装-minikube也可以购买商业-kubernetes-集群">安装 Minikube（也可以购买商业 Kubernetes 集群）</h4>
<p>推荐使用 Minikube v0.28 以上来体验，请参考 <a href="https://github.com/kubernetes/minikube">minikube doc</a>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ brew cask install minikube
</code></pre></div><h4 id="启动-minikube">启动 Minikube</h4>
<p>注意，pilot 至少需要 2G 内存，所以在启动的时候，可以通过加参数的方法给 minikube 添加分配的资源，如果你机器的资源不够，推荐使用商业版本的 Kubernetes 集群。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ minikube start --memory<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8192</span> --cpus<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span> --kubernetes-version<span style="color:#ce5c00;font-weight:bold">=</span>v1.15.0 --vm-driver<span style="color:#ce5c00;font-weight:bold">=</span>hyperkit
</code></pre></div><p>创建 istio 命名空间</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl create namespace istio-system
</code></pre></div><h4 id="安装-kubectl-命令行工具">安装 kubectl 命令行工具</h4>
<p>kubectl 是用于针对 Kubernetes 集群运行命令的命令行接口，安装参考 <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl">kubectl doc</a>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ brew install kubernetes-cli
</code></pre></div><h2 id="部署istio与mosn">部署Istio与MOSN</h2>
<h3 id="安装-istio">安装 Istio</h3>
<p>您可以在 <a href="https://github.com/istio/istio/releases/tag/1.5.2">Istio release</a> 页面下载与您操作系统匹配的压缩文件，该文件中包含：安装文件、示例和 istioctl 命令行工具。使用如下命令来下载 Istio（本文示例使用的是 Istio 1.5.2）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#204a87">export</span> <span style="color:#000">ISTIO_VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span>1.5.2 <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> curl -L https://istio.io/downloadIstio <span style="color:#000;font-weight:bold">|</span> sh -
</code></pre></div><p>下载的 Istio 包名为 <code>istio-1.5.2</code>，包含：</p>
<ul>
<li><code>install/kubernetes</code>：包含 Kubernetes 相关的 YAML 安装文件;</li>
<li><code>examples/</code>：包含示例应用程序;</li>
<li><code>bin/</code>：包含 istioctl 的客户端文件;</li>
</ul>
<p>切换到 Istio 包所在目录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#204a87">cd</span> istio-<span style="color:#000">$ISTIO_VERSION</span>/
</code></pre></div><p>使用如下命令将 istioctl 客户端路径加入 $PATH 中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#204a87">export</span> <span style="color:#000">PATH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$PATH</span>:<span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">pwd</span><span style="color:#204a87;font-weight:bold">)</span>/bin
</code></pre></div><p>截止目前，我们已经可以通过 istioctl 命令行工具来灵活的自定义 Istio 控制平面和数据平面配置参数。</p>
<h3 id="设置-mosn-作为-istio-的-sidecar">设置 MOSN 作为 Istio 的 Sidecar</h3>
<p>通过 istioctl 命令的参数指定 MOSN 作为 Istio 中的数据面：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ istioctl manifest apply  --set .values.global.proxy.image<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;mosnio/proxyv2:1.5.2-mosn&#34;</span>   --set meshConfig.defaultConfig.binaryPath<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/usr/local/bin/mosn&#34;</span>
</code></pre></div><h3 id="修改-prometheus-deployment">修改 prometheus deployment</h3>
<p>当前版本的部署的 istio 自带的 <code>prometheus</code>，有2个小问题需要手动调整下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl edit deployments -n istio-system prometheus
</code></pre></div><ol>
<li>将容器 <code>istio-proxy</code> 的镜像改为 <code>mosnio/proxyv2:1.5.2-mosn</code></li>
<li>将容器 <code>istio-proxy</code> 启动参数中的 <code>--binaryPath</code> 的值改为 <code>/usr/local/bin/mosn</code></li>
</ol>
<h3 id="验证安装">验证安装</h3>
<p>检查 Istio 相关 pod 服务是否部署成功：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get pod -n istio-system
NAME                                    READY   STATUS    RESTARTS   AGE
istio-ingressgateway-6f68796974-mtp2q   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6h10m
istiod-768488f855-c7bf6                 1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6h35m
prometheus-6cd5bb8f99-8szvt             2/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          13m
</code></pre></div><p>如果服务状态 STATUS 为 Running，则表示 Istio 已经成功安装，后面就可以部署 Bookinfo 示例了。</p>
<p>我们可以登录到 <code>istio-ingressgateway-6f68796974-mtp2q</code> pod 上查看该网关已经成功使用MOSN作为 <code>ingress-gateway</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl -n istio-system <span style="color:#204a87">exec</span> -it istio-ingressgateway-6f68796974-mtp2q -- bash
root@istio-ingressgateway-6f68796974-mtp2q:/# ps aux <span style="color:#000;font-weight:bold">|</span> grep mosn
root        <span style="color:#0000cf;font-weight:bold">21</span>  0.1  0.3 <span style="color:#0000cf;font-weight:bold">129588</span> <span style="color:#0000cf;font-weight:bold">26080</span> ?        Sl   10:47   0:38 /usr/local/bin/mosn start --config /etc/istio/proxy/envoy-rev0.json --service-cluster istio-ingressgateway --service-node router~172.17.0.5~istio-ingressgateway-6f68796974-mtp2q.istio-system~istio-system.svc.cluster.local
root        <span style="color:#0000cf;font-weight:bold">57</span>  0.0  0.0  <span style="color:#0000cf;font-weight:bold">11468</span>  <span style="color:#0000cf;font-weight:bold">1012</span> pts/0    S+   16:58   0:00 grep --color<span style="color:#ce5c00;font-weight:bold">=</span>auto mosn
</code></pre></div><h2 id="bookinfo-示例">Bookinfo 示例</h2>
<p>MOSN 已通过 Istio 1.5.2 的 <code>BookInfo</code> 测试，相关支持动态请关注 <a href="https://github.com/mosn/community/blob/master/wg-istio.md">MOSN Istio WG</a>。</p>
<p>可以通过 <a href="https://katacoda.com/mosn/courses/istio/mosn-with-istio">MOSN with Istio</a> 的教程来进行 Bookinfo 示例的演示操作，另外在该教程中您也可以找到更多关于使用 MOSN 和 Istio 的说明。</p>
<h3 id="bookinfo-实验">BookInfo 实验</h3>
<p><code>BookInfo</code> 是一个类似豆瓣的图书应用，它包含四个基础服务：</p>
<ul>
<li>Product Page：主页，由 python 开发，展示所有图书信息，它会调用 Reviews 和 Details 服务</li>
<li>Reviews：评论，由 java 开发，展示图书评论，会调用 Ratings 服务</li>
<li>Ratings：评分服务，由 nodejs 开发</li>
<li>Details：图书详情，由 ruby 开发</li>
</ul>
<div align=center><img src="bookinfo.png" width = "550" height = "400" alt="bookinfo" /></div>
<h4 id="部署-bookinfo-应用并注入-mosn">部署 <code>BookInfo</code> 应用并注入 MOSN</h4>
<blockquote>
<p>详细过程可以参考 <a href="https://istio.io/docs/examples/bookinfo/">BookInfo doc</a></p>
</blockquote>
<p>通过 kube-inject 的方式实现Sidecar注入：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml &gt; bookinfo.yaml <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sed -i <span style="color:#4e9a06">&#34;s/\/usr\/local\/bin\/envoy/\/usr\/local\/bin\/mosn/g&#34;</span> ./bookinfo.yaml
</code></pre></div><p>部署注入 Sidecar 后的 Bookinfo 应用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f bookinfo.yaml
</code></pre></div><p>验证部署是否成功：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get services
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>    AGE
details       ClusterIP   10.107.154.89   &lt;none&gt;        9080/TCP   65m
kubernetes    ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP    10h
productpage   ClusterIP   10.101.154.61   &lt;none&gt;        9080/TCP   65m
ratings       ClusterIP   10.103.70.21    &lt;none&gt;        9080/TCP   65m
reviews       ClusterIP   10.96.56.145    &lt;none&gt;        9080/TCP   65m
</code></pre></div><p>等待所有的 pod 等成功运行起来：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get pods
NAME                              READY   STATUS    RESTARTS   AGE
details-v1-547d75b975-zrhtf       2/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          66m
productpage-v1-84b8bbd5bb-pc2hc   2/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          66m
ratings-v1-b78b5cb7-hvtwv         2/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          66m
reviews-v1-576d4b46f4-84cw9       2/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          66m
reviews-v2-68b67dcd98-d286b       2/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          66m
reviews-v3-784c6444b-blbgr        2/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          66m
</code></pre></div><p>当上述状态为 Running 后，可通过如下方式确认 Bookinfo 应用是否正常运行：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl <span style="color:#204a87">exec</span> -it <span style="color:#204a87;font-weight:bold">$(</span>kubectl get pod -l <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>ratings -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;{.items[0].metadata.name}&#39;</span><span style="color:#204a87;font-weight:bold">)</span> -c ratings -- curl productpage:9080/productpage <span style="color:#000;font-weight:bold">|</span> grep -o <span style="color:#4e9a06">&#34;&lt;title&gt;.*&lt;/title&gt;&#34;</span>
</code></pre></div><p>同样我们可以查看此时 <code>BookInfo</code> 应用的每一个 pod 都运行了 2 个容器，一个容器是 <code>BookInfo</code> 自身业务容器，另一个容器是Istio注入的 sidecar MOSN 容器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl <span style="color:#204a87">exec</span> -it productpage-v1-84b8bbd5bb-pc2hc -c istio-proxy -- bash
istio-proxy@productpage-v1-84b8bbd5bb-pc2hc:/$ ps aux <span style="color:#000;font-weight:bold">|</span> grep mosn
istio-p+     <span style="color:#0000cf;font-weight:bold">1</span>  0.1  0.5 <span style="color:#0000cf;font-weight:bold">153964</span> <span style="color:#0000cf;font-weight:bold">41372</span> ?        Ssl  16:59   0:04 /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --configPath /etc/istio/proxy --binaryPath /usr/local/bin/mosn --serviceCluster productpage.default --drainDuration 45s --parentShutdownDuration 1m0s --discoveryAddress istiod.istio-system.svc:15012 --zipkinAddress zipkin.istio-system:9411 --proxyLogLevel<span style="color:#ce5c00;font-weight:bold">=</span>warning --proxyComponentLogLevel<span style="color:#ce5c00;font-weight:bold">=</span>misc:error --connectTimeout 10s --proxyAdminPort <span style="color:#0000cf;font-weight:bold">15000</span> --concurrency <span style="color:#0000cf;font-weight:bold">2</span> --controlPlaneAuthPolicy NONE --dnsRefreshRate 300s --statusPort <span style="color:#0000cf;font-weight:bold">15020</span> --trust-domain<span style="color:#ce5c00;font-weight:bold">=</span>cluster.local --controlPlaneBootstrap<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>
istio-p+    <span style="color:#0000cf;font-weight:bold">18</span>  0.1  0.3 <span style="color:#0000cf;font-weight:bold">129584</span> <span style="color:#0000cf;font-weight:bold">25904</span> ?        Sl   16:59   0:05 /usr/local/bin/mosn start --config /etc/istio/proxy/envoy-rev0.json --service-cluster productpage.default --service-node sidecar~172.17.0.14~productpage-v1-84b8bbd5bb-pc2hc.default~default.svc.cluster.local
istio-p+    <span style="color:#0000cf;font-weight:bold">59</span>  0.0  0.0  <span style="color:#0000cf;font-weight:bold">11464</span>  <span style="color:#0000cf;font-weight:bold">1156</span> pts/0    S+   17:54   0:00 grep --color<span style="color:#ce5c00;font-weight:bold">=</span>auto mosn
</code></pre></div><h4 id="访问-bookinfo-服务">访问 BookInfo 服务</h4>
<p>开启 gateway 模式。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
$ kubectl get gateway        // 查看 gateway 是否运行起来
NAME               AGE
bookinfo-gateway   24m
</code></pre></div><p>设置 <code>GATEWAY_URL</code> 参考<a href="https://istio.io/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports">文档</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#204a87">export</span> <span style="color:#000">INGRESS_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>kubectl -n istio-system get service istio-ingressgateway -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;{.spec.ports[?(@.name==&#34;http2&#34;)].nodePort}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
$ <span style="color:#204a87">export</span> <span style="color:#000">SECURE_INGRESS_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>kubectl -n istio-system get service istio-ingressgateway -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;{.spec.ports[?(@.name==&#34;https&#34;)].nodePort}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
$ <span style="color:#204a87">export</span> <span style="color:#000">INGRESS_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>minikube ip<span style="color:#204a87;font-weight:bold">)</span>
$ <span style="color:#204a87">export</span> <span style="color:#000">GATEWAY_URL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$INGRESS_HOST</span>:<span style="color:#000">$INGRESS_PORT</span>
</code></pre></div><p>验证 gateway 是否生效，输出 <code>200</code> 表示成功。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -o /dev/null -s -w <span style="color:#4e9a06">&#34;%{http_code}\n&#34;</span>  http://<span style="color:#000">$GATEWAY_URL</span>/productpage
<span style="color:#0000cf;font-weight:bold">200</span>
</code></pre></div><p><strong>观察页面情况</strong></p>
<p>访问 <code>http://$GATEWAY_URL/productpage</code> (注意： <code>$GATEWAY_URL</code> 需要替换成你设置的地址)，正常的话通过刷新会看到如下所示 <code>BookInfo</code> 的界面，其中 Book Reviews 有三个版本，刷新后依次会看到(可以查看 samples/bookinfo/platform/kube/bookinfo.yaml 中的配置发现为什么是这三个版本)版本一的界面。</p>
<p><img src="v1.png" alt="版本一"></p>
<p>版本二的界面。</p>
<p><img src="v2.png" alt="版本二"></p>
<p>版本三的界面。</p>
<p><img src="v3.png" alt="版本三"></p>
<h4 id="验证-mosn-按-version-路由能力">验证 MOSN 按 version 路由能力</h4>
<p>首先为 <code>BookInfo</code> 的 service 创建一系列的 destination rules。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml
</code></pre></div><p>指定 reviews 服务只访问 v1 版本。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div><p>访问 <code>http://$GATEWAY_URL/productpage</code> 发现 reviews 固定在如下版本一的页面不再变化。</p>
<p><img src="v1.png" alt="版本一"></p>
<h4 id="验证-mosn-按-weight-路由能力">验证 MOSN 按 weight 路由能力</h4>
<p>我们通过下面操作将 v1 和 v3 版本各分配 50% 的流量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml
</code></pre></div><p>访问 <code>http://$GATEWAY_URL/productpage</code> 这次 v1 和 v3 各有 1/2 几率出现。</p>
<h4 id="验证-mosn-按照特定-header-路由能力">验证 MOSN 按照特定 header 路由能力</h4>
<p><code>BookInfo</code> 系统右上角有一个登陆的入口，登陆以后请求会带上 end-user 这个自定义，值是 user name，Mosn 支持根据这个 header 的值来做路由。比如，我们尝试将 jason 这个用户路由到 v2 版本，其他的路由到 v1 版本（用户名和密码均是：jason，为什么是这个用户可以查看对应的 yaml 文件）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre></div><p>访问 <code>http://$GATEWAY_URL/productpage</code> 时：</p>
<p>以 jason 身份登陆，会看到 v2 版本。</p>
<p><img src="login.png" alt="登录"></p>
<p>以其他身份登录，始终在 v1 版本。</p>
<p><img src="v1.png" alt="版本一"></p>
<h3 id="卸载-bookinfo">卸载 BookInfo</h3>
<p>可以使用下面的命令来完成应用的删除和清理工作：</p>
<p>删除路由规则，并销毁应用的 Pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sh samples/bookinfo/platform/kube/cleanup.sh
</code></pre></div><p>确认 <code>BookInfo</code> 应用已经关停：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get virtualservices   <span style="color:#8f5902;font-style:italic">#-- there should be no virtual services</span>
$ kubectl get destinationrules  <span style="color:#8f5902;font-style:italic">#-- there should be no destination rules</span>
$ kubectl get gateway           <span style="color:#8f5902;font-style:italic">#-- there should be no gateway</span>
$ kubectl get pods              <span style="color:#8f5902;font-style:italic">#-- the Bookinfo pods should be deleted</span>
</code></pre></div><h2 id="卸载-istio">卸载 Istio</h2>
<p>执行如下命令，删除 Istio 相关 CRD 以及 pod 等资源：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">istioctl manifest generate --set .values.global.proxy.image<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;mosnio/proxyv2:1.5.2-mosn&#34;</span> --set meshConfig.defaultConfig.binaryPath<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/usr/local/bin/mosn&#34;</span> <span style="color:#000;font-weight:bold">|</span> kubectl delete -f -
</code></pre></div><p>确认 Istio 是否成功卸载：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get namespace istio-system
</code></pre></div>
	
	
	<div class="text-muted mt-5 pt-3 border-top">修改于 2021年2月8日: <a  href="https://github.com/apache/incubator-brpc-website/commit/5f9db5dcfae8d85b9765ef0899627903d2990fe3">add build proxyv2 docs. (#131) (5f9db5d)</a>
</div>
</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-12 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" href="https://github.com/apache/incubator-brpc">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The bRPC Authors 保留所有权利</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>






<script src="/js/main.min.170adf90fd476d5f9243ed2e727149abe8d9fe364587fe943765d47375bbd1ad.js" integrity="sha256-FwrfkP1HbV&#43;SQ&#43;0ucnFJq&#43;jZ/jZFh/6UN2XUc3W70a0=" crossorigin="anonymous"></script>





  </body>
</html>